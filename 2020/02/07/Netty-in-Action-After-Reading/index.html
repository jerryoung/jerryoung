<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/images/icons/icon-72x72.png"><link rel="icon" href="/images/icons/icon-72x72.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="Jerry Wu"><meta name="keywords" content="程序员, java, blockchain, developer"><meta name="description" content="开编我想说 刻意练习，本着课本的例子，照着我也写一遍的原则进行练习。    基础知识真的太重要，很多基础知识是会影响我们阅读书的效果，甚至可能会误解书本的原意。就拿着当前阅读的书来说起，如果我们不知道计算机操作系统基础，不知Java网络编程基础，不知网络协议等，那么我们看书可能会举步维艰。所以，在看本书之前，我尝试查阅一些相关资料，以补充能够更好吸收书本知识。   本文章，就是书本很多地方的内容，"><meta property="og:type" content="article"><meta property="og:title" content="《Netty in Action》 读后感"><meta property="og:url" content="https://jaryoung.com/2020/02/07/Netty-in-Action-After-Reading/index.html"><meta property="og:site_name" content="程序猿清丰"><meta property="og:description" content="开编我想说 刻意练习，本着课本的例子，照着我也写一遍的原则进行练习。    基础知识真的太重要，很多基础知识是会影响我们阅读书的效果，甚至可能会误解书本的原意。就拿着当前阅读的书来说起，如果我们不知道计算机操作系统基础，不知Java网络编程基础，不知网络协议等，那么我们看书可能会举步维艰。所以，在看本书之前，我尝试查阅一些相关资料，以补充能够更好吸收书本知识。   本文章，就是书本很多地方的内容，"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://s2.ax1x.com/2020/02/07/12Z6ns.png"><meta property="article:published_time" content="2020-02-07T13:59:12.000Z"><meta property="article:modified_time" content="2022-02-09T03:19:17.081Z"><meta property="article:author" content="Jerry Wu"><meta property="article:tag" content="Netty"><meta property="article:tag" content="Java"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://s2.ax1x.com/2020/02/07/12Z6ns.png"><link rel="manifest" href="/manifest.json"><script src="/sw-register.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4246138471118676" crossorigin="anonymous"></script><title>《Netty in Action》 读后感 | 程序猿清丰</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/my.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_2744905_iihiav2q76.css"><script id="fluid-configs">var Fluid=window.Fluid||{},CONFIG={hostname:"jaryoung.com",root:"/",version:"1.8.14",typing:{enable:!0,typeSpeed:70,cursorChar:"_",loop:!1,scope:["home"]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:"ture",baidu:"30a17f235b72eb0b6b00ebd50502c5a2",google:"UA-219214701-1",gtag:302173009,tencent:{sid:null,cid:null},woyaola:null,cnzz:1280822839,leancloud:{app_id:"AVw7kqBWv8BqLExXq2drwbG3-gzGzoHsz",app_key:"I6ePpCb4W1A02o7TIXkrgrPX",server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml"}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="程序猿清丰" type="application/atom+xml">
</head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>程序猿清丰</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-layer-group"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(https://cdn.pixabay.com/photo/2020/05/07/04/01/digitization-5140071_1280.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle" title="《Netty in Action》 读后感">《Netty in Action》 读后感</span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> Jerry Wu </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2020-02-07 21:59" pubdate>2020年2月7日 21:59</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 31k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 255 分钟 </span><span id="leancloud-page-views-container" class="post-meta" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="leancloud-page-views"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">《Netty in Action》 读后感</h1><p class="note note-info">本文最后更新于：2022年2月9日 11:19</p><div class="markdown-body"><h2 id="开编我想说"><a href="#开编我想说" class="headerlink" title="开编我想说"></a>开编我想说</h2><blockquote><p>刻意练习，本着课本的例子，照着我也写一遍的原则进行练习。</p></blockquote><p>基础知识真的太重要，很多基础知识是会影响我们阅读书的效果，甚至可能会误解书本的原意。就拿着当前阅读的书来说起，如果我们不知道计算机操作系统基础，不知Java网络编程基础，不知网络协议等，那么我们看书可能会举步维艰。所以，在看本书之前，我尝试查阅一些相关资料，以补充能够更好吸收书本知识。</p><p>本文章，就是书本很多地方的内容，并未能深刻理解，一本书的内容也不可能全部呈现。例如，零拷贝，各种网络协议的理解，例如tcp，udp协议等。很多基础内容，都感觉相对薄弱，所以日后需要加强基础的部分。<br>看完，你可能会有以下收获：<br>Netty核心组件、重新认识字节、关于Netty单元测试、编码器和解码器、WebSocket简单的聊天室</p><span id="more"></span><h2 id="阅读前的预习，大有裨益"><a href="#阅读前的预习，大有裨益" class="headerlink" title="阅读前的预习，大有裨益"></a>阅读前的预习，大有裨益</h2><ul><li>同步和异步的概念</li></ul><blockquote><p>同步，是一个可靠的有序操作，例如，有顺序执行操作A-&gt;操作B，如果操作A没有完成返回，操作B需要排队等候；反之，异步则相反无需等待，通常可以依靠回调或者事件的方式来进行操作的次序的问题。</p></blockquote><ul><li>堵塞和非堵塞</li></ul><blockquote><p>在进行阻塞操作时，当前线程会处于阻塞状态，无法从事其他任务，只有当条件就绪才能继续，比如 ServerSocket 新连接建立完毕，或数据读取、写入操作完成；而非阻塞则是不管 IO 操作是否结束，直接返回，相应操作在后台继续处理。</p></blockquote><ul><li><p>查询常见的I&#x2F;O模型：I&#x2F;O堵塞;I&#x2F;O非堵塞;I&#x2F;O复用；信号驱动I&#x2F;O；异步I&#x2F;O<br><img src="https://s2.ax1x.com/2020/02/07/1cIMQI.png" srcset="/img/loading.gif" lazyload alt="1cIMQI.png"></p></li><li><p>用户空间和系统空间</p></li></ul><blockquote><p>现在操作系统都是采用虚拟存储器，那么对32位操作系统而言，它的寻址空间（虚拟存储空间）为4G（2的32次方）。操作系统的核心是内核，独立于普通的应用程序，可以访问受保护的内存空间，也有访问底层硬件设备的所有权限。为了保证用户进程不能直接操作内核（kernel），保证内核的安全，操心系统将虚拟空间划分为两部分，一部分为内核空间，一部分为用户空间。针对linux操作系统而言，将最高的1G字节（从虚拟地址0xC0000000到0xFFFFFFFF），供内核使用，称为内核空间，而将较低的3G字节（从虚拟地址0x00000000到0xBFFFFFFF），供各个进程使用，称为用户空间。<a target="_blank" rel="noopener" href="https://yuelng.github.io/2018/03/16/computer_science/network_coding/">摘抄自这里</a></p></blockquote><ul><li>Linux 操作系统中select、poll、epoll<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/binarylei/p/11130079.html#select-api">详细内容可以查看</a></li><li>High-Performance I&#x2F;O Design Patterns<br><a target="_blank" rel="noopener" href="https://www.artima.com/articles/io_design_patterns.html">详细内容可以看</a></li></ul><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><blockquote><p>Netty is an asynchronous event-driven network application framework<br>for rapid development of maintainable high performance protocol servers &amp; clients.</p></blockquote><p>从上面我抽取了三个关键词，asynchronous、event-driven、high performance。带着三个关键信息，看能够从书中摄取到三个核心的内容。</p><h2 id="核心内容"><a href="#核心内容" class="headerlink" title="核心内容"></a>核心内容</h2><h3 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h3><h4 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h4><blockquote><p>Channel，是出入站数据的载体，或者是网络中Socket抽象代表。<br>目的：Channel为了降低直接使用Java中Socket API的复杂度。</p></blockquote><p>Channel的生命周期：register-&gt;active-&gt;inactive-&gt;unregistred</p><h4 id="EventLoop"><a href="#EventLoop" class="headerlink" title="EventLoop"></a>EventLoop</h4><blockquote><p>用于处理连接的生命周期的中发生的事件</p></blockquote><p>Channel、EventLoop和EventLoopGroup的关系图<br><img src="https://s2.ax1x.com/2020/02/07/1czd5n.png" srcset="/img/loading.gif" lazyload alt="1czd5n.png"></p><p>图中可以看到EventLoopGroup其实就具有多个EventLoop的组，EventLoop会在Channel的整个生命周期处理I&#x2F;O事件。<br>三者关系如下：</p><ul><li>一个EventLoopGroup包含一个或者多个EventLoop</li><li>一个EventLoop一个生命周期中，只和一个线程绑定</li><li>EventLoop所有I&#x2F;O处理事件，将有专用的线程处理</li><li>一个Channel生命周期，只会注册到一个EventLoop上</li><li>一个EventLoop可以会分配多个Channel</li></ul><p>得益于EventLoop是一个固定的线程处理，给定的Channel上的I&#x2F;O的处理将会在同一个线程处理，避免了不必要的线程切换上下文的开销；</p><p>下面来深入了解一下，EventLoop：<br>先通过类图去纵览<br><img src="https://s2.ax1x.com/2020/02/07/1guZWT.png" srcset="/img/loading.gif" lazyload alt="1guZWT.png"></p><ul><li>java.util.concurrent<br>AbstractExecutorService主要是实现了ExecutorService接口，ScheduledExecutorService则是继承了ExecutorService；</li><li>io.netty.utilconcurrent<br>AbstractEventExecutor，继承了AbstractExecutorService类，并且实现EventExecutor接口，</li><li>io.netty.channel<br>EventLoop，继承了OrderedEventExecutor, EventLoopGroup，只有一个：EventLoopGroup parent()方法。<br>SingleThreadEventLoop，继承SingleThreadEventExecutor，并且实现EventLoop接口；<br>重头戏来了，NioEventLoop，是继承了SingleThreadEventLoop，正如上面所说的：<code>一个EventLoop一个生命周期中，只和一个线程绑定</code></li></ul><p>EventLoop的执行逻辑：<br><img src="https://s2.ax1x.com/2020/02/07/1g3qc6.png" srcset="/img/loading.gif" lazyload alt="1g3qc6.png"></p><h4 id="ChannelPipeline"><a href="#ChannelPipeline" class="headerlink" title="ChannelPipeline"></a>ChannelPipeline</h4><blockquote><p>pipeline，意译为管道，ChannelPipeline，一看到这个名字，我们能够猜到它的作用就是类似管道的作用。<br>目的：为了提供ChannelHandler链式容器（ChannelHandler在下一节介绍）</p></blockquote><p><img src="https://s2.ax1x.com/2020/02/07/1gpYkj.png" srcset="/img/loading.gif" lazyload alt="1gpYkj.png"></p><p>本节，需要了解pipeline它的头部和尾部的概念，入站从头部第一个ChannelHandler先入，出站的时候从尾端端第一个ChannelHandler先开始流出。</p><p>顺便提一下，Channel一旦分配为ChannelPipeline后，是永久性操作，不能被修改。<br>通过 DefaultChannelPipeline 和 AbstractChannel 源代码分析，也能得到上面的结论：</p><figure class="highlight java"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><pre><code class="hljs java">AbstractChannel<br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">AbstractChannel</span><span class="hljs-params">(Channel parent)</span> &#123;<br>    ...<br>        pipeline = newChannelPipeline();<span class="hljs-comment">// 新建分配一个ChannelPipeline</span><br>    &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">DefaultChannelPipeline<br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">DefaultChannelPipeline</span><span class="hljs-params">(Channel channel)</span> &#123;<br>    ...<br>        <span class="hljs-built_in">this</span>.channel = ObjectUtil.checkNotNull(channel, <span class="hljs-string">&quot;channel&quot;</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><p>最后，上面的设计使得，我们 <strong>变动（增删改）</strong> ChannelPipeline上的Handler也是相当方便的。</p><h4 id="ChannelHandler"><a href="#ChannelHandler" class="headerlink" title="ChannelHandler"></a>ChannelHandler</h4><blockquote><p>ChannelHandler，它充当了所有处理入站和出站数据的应用程序逻辑的容器。<br>ChannelHandler生命周期：added-&gt;removed (excption)<br>通过ChannelHandler再来看出入站的概念：<br>入站，就是数据流要进行我们的服务前置的业务处理。出站，就是我们需要返回数据流时候的后置业务处理。当然我们还是需要谨记，上一节的pipeline的头部和尾端的概念，不然会容易出或者入站的handler出现位置不对的情况。</p></blockquote><ul><li>ChannelInboundHandler 入站处理器接口，处理入站数据和状态变化<br>列出我在练习中常用的方法：</li></ul><table><thead><tr><th>类　　型</th><th>描　　述</th></tr></thead><tbody><tr><td>channelRegistered</td><td>当Channel已经注册到它的EventLoop并且能够处理I&#x2F;O时被调用</td></tr><tr><td>channelUnregistered</td><td>当Channel从它的EventLoop注销并且无法处理任何I&#x2F;O时被调用</td></tr><tr><td>channelActive</td><td>当Channel处于活动状态时被调用；Channel已经连接&#x2F;绑定并且已经就绪</td></tr><tr><td>channelInactive</td><td>当Channel离开活动状态并且不再连接它的远程节点时被调用</td></tr><tr><td>channelReadComplete</td><td>当Channel上的一个读操作完成时被调用</td></tr><tr><td>channelRead</td><td>当从Channel读取数据时被调用</td></tr><tr><td>userEventTriggered</td><td>当ChannelnboundHandler.fireUserEventTriggered()方法被调用时被调用，因为一个POJO被传经了ChannelPipeline</td></tr></tbody></table><p>我们可以通过继承 ChannelInboundHandlerAdapter 来编写自己的入站处理器。常用的是：SimpleChannelInboundHandler，因为它给我优化了一些常用的操作，例如，资源的自动释放等</p><p>异常处理：<br>exceptionCaught，这个方法在 ChannelInboundHandlerAdapter 已经标记被弃用，</p><ul><li>ChannelOutboundHandler 出站处理器接口，处理出站的所有数据，并且能够拦截所有的操作。<br>列出我在练习中常用的方法：</li></ul><table><thead><tr><th>类　　型</th><th>描　　述</th></tr></thead><tbody><tr><td>bind(ChannelHandlerContext,SocketAddress,ChannelPromise)</td><td>当请求将Channel绑定到本地地址时被调用</td></tr><tr><td>connect(ChannelHandlerContext,SocketAddress,SocketAddress,ChannelPromise)当</td><td>请求将Channel连接到远程节点时被调用</td></tr><tr><td>disconnect(ChannelHandlerContext,ChannelPromise)</td><td>当请求将Channel从远程节点断开时被调用</td></tr><tr><td>close(ChannelHandlerContext,ChannelPromise)</td><td>当请求关闭Channel时被调用</td></tr><tr><td>deregister(ChannelHandlerContext,ChannelPromise)</td><td>当请求将Channel从它的EventLoop注销时被调用</td></tr><tr><td>read(ChannelHandlerContext)</td><td>当请求从Channel读取更多的数据时被调用</td></tr><tr><td>flush(ChannelHandlerContext)</td><td>当请求通过Channel将入队数据冲刷到远程节点时被调用</td></tr><tr><td>write(ChannelHandlerContext,Object,ChannelPromise)</td><td>当请求通过Channel将数据写到远程节点时被调用</td></tr></tbody></table><p>异常处理：<br>两种方式：</p><ol><li>在出站操作都会返回ChannelFuture，进行添加监听事件</li><li>在ChannelOutboundHandler的入参都会带有ChannelPromis，进行添加监听事件<br>方式2更加常用，因为相对方式1相关更加简单有效。</li></ol><h4 id="ChannelHandlerContext"><a href="#ChannelHandlerContext" class="headerlink" title="ChannelHandlerContext"></a>ChannelHandlerContext</h4><p>紧接上面，我来看一下Channel、ChannelPipeline、ChannelHandler和ChannelHandlerContext之间的关系：<br><img src="https://s2.ax1x.com/2020/02/07/123uKf.png" srcset="/img/loading.gif" lazyload alt="123uKf.png"><br>当ChannelHandler添加到ChannelPipeline到时候，ChannelHandlerContext将会被创建。</p><p>ChannelHandler高级用法：我们可以在使用ChannelHandler可以缓存ChannelHanlderContext，然后去完成一些复杂的操作。<br>但是这里是有一个前提，就是当前ChannelHandler应该是被@Sharable注释，因为一个ChannelHandler可能属于多个ChannelPipeline。在使用@Sharable之前，最好确保当前ChannelHandler是线程安全。</p><h4 id="ChannelFuture"><a href="#ChannelFuture" class="headerlink" title="ChannelFuture"></a>ChannelFuture</h4><blockquote><p>Netty提供了ChannelFuture接口，其addListener()方法注册了一个ChannelFutureListener，以便在某个操作完成时（无论是否成功）得到通知。</p></blockquote><h4 id="Bootstrap"><a href="#Bootstrap" class="headerlink" title="Bootstrap"></a>Bootstrap</h4><p><img src="https://s2.ax1x.com/2020/02/07/1gyOJ0.png" srcset="/img/loading.gif" lazyload alt="1gyOJ0.png"></p><ul><li>引导客户端 和 无连接协议<br>引导流程如下：<br><img src="https://s2.ax1x.com/2020/02/07/1g6GSf.png" srcset="/img/loading.gif" lazyload alt="1g6GSf.png"></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EchoClient</span> &#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">SSL</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;ssl&quot;</span>) != <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">HOST</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;host&quot;</span>, <span class="hljs-string">&quot;127.0.0.1&quot;</span>);<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PORT</span> <span class="hljs-operator">=</span> Integer.parseInt(System.getProperty(<span class="hljs-string">&quot;port&quot;</span>, <span class="hljs-string">&quot;8023&quot;</span>));<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// Configure SSL.git</span><br>        <span class="hljs-keyword">final</span> SslContext sslCtx;<br>        <span class="hljs-keyword">if</span> (SSL) &#123;<br>            sslCtx = SslContextBuilder.forClient()<br>                    .trustManager(InsecureTrustManagerFactory.INSTANCE).build();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            sslCtx = <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// Configure the client.</span><br>        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Bootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>();<br>            b.group(group)<br>                    .channel(NioSocketChannel.class)<br>                    .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                            <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();<br>                            <span class="hljs-keyword">if</span> (sslCtx != <span class="hljs-literal">null</span>) &#123;<br>                                p.addLast(sslCtx.newHandler(ch.alloc(), HOST, PORT));<br>                            &#125;<br>                            p.addLast(<br>                                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomSimpleChannelInboundHandler</span>())<br>                            ;<br>                        &#125;<br>                    &#125;);<br><br>            <span class="hljs-comment">// 在connect方法调用后，Bootstrap类将会创建一个新的Channel</span><br>            <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> b.connect(HOST, PORT).sync();<br><br>            <span class="hljs-comment">// Wait until the connection is closed.</span><br>            f.channel().closeFuture().sync();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">// Shut down the event loop to terminate all threads.</span><br>            group.shutdownGracefully();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><ul><li>引导服务器</li></ul><p>引导流程如下：<br><img src="https://s2.ax1x.com/2020/02/07/1g6tOg.png" srcset="/img/loading.gif" lazyload alt="1g6tOg.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EchoServer</span> &#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">SSL</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;ssl&quot;</span>) != <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">PORT</span> <span class="hljs-operator">=</span> Integer.parseInt(System.getProperty(<span class="hljs-string">&quot;port&quot;</span>, <span class="hljs-string">&quot;8007&quot;</span>));<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SECOND_HANDLER_NAME</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;second&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// Configure SSL.</span><br>        <span class="hljs-keyword">final</span> SslContext sslCtx;<br>        <span class="hljs-keyword">if</span> (SSL) &#123;<br>            <span class="hljs-type">SelfSignedCertificate</span> <span class="hljs-variable">ssc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SelfSignedCertificate</span>();<br>            sslCtx = SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey()).build();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            sslCtx = <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// Configure the server.</span><br>        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workerGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">EchoServerHandler</span> <span class="hljs-variable">serverHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EchoServerHandler</span>();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();<br>            b.group(bossGroup, workerGroup)<br>                    .channel(NioServerSocketChannel.class)<br>                    .option(ChannelOption.SO_BACKLOG, <span class="hljs-number">100</span>)<br>                    .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoggingHandler</span>(LogLevel.INFO))<br>                    .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                            <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();<br>                            <span class="hljs-keyword">if</span> (sslCtx != <span class="hljs-literal">null</span>) &#123;<br>                            p.addLast(sslCtx.newHandler(ch.alloc()));<br>                            p.addLast(serverHandler);<br>                        &#125;<br>                    &#125;);<br><br>            <span class="hljs-comment">// Start the server.</span><br>            <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> b.bind(PORT).sync();<br><br>            <span class="hljs-comment">// Wait until the server socket is closed.</span><br>            f.channel().closeFuture().sync();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">// Shut down all event loops to terminate all threads.</span><br>            bossGroup.shutdownGracefully();<br>            workerGroup.shutdownGracefully();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><ul><li><p>引导DatagramChannel<br>Netty提供了各种DatagramChannel的实现，它唯一的区别就是不能使用connect方法，只能调用bind方法。</p></li><li><p>如何优雅关闭客户端和服务端</p></li></ul><blockquote><p>我主要需要关闭我们创建EventLoopGroup，我们可以通过<code>shutdownGracefully</code>方法来优雅地关闭。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Future&lt;?&gt; shutdownGracefully(<span class="hljs-type">long</span> quietPeriod, <span class="hljs-type">long</span> timeout, TimeUnit unit) &#123;<br>    <span class="hljs-keyword">for</span> (EventExecutor l: children) &#123;<br>        l.shutdownGracefully(quietPeriod, timeout, unit);<br>    &#125;<br>    <span class="hljs-keyword">return</span> terminationFuture();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="重新认识字节"><a href="#重新认识字节" class="headerlink" title="重新认识字节"></a>重新认识字节</h3><blockquote><p>The byte is a unit of digital information that most commonly consists of eight bits. Historically, the byte was the number of bits used to encode a single character of text in a computer and for this reason it is the smallest addressable unit of memory in many computer architectures<br>记住：8 bit &#x3D; 1 byte</p></blockquote><p>为啥说重新认识了字节，因为自己在学习ByteBuf的时候犯了一些低级的错误（单元测试将呈现我的低级错误），反应出来自己的基础还是不够牢固。<br>下面这通过练习的例子，来认识一下Netty强大的字节容器：ByteBuff</p><blockquote><p>ByteBuff，实现原理有两个索引指针，一个用于读取（readerIndex），一个用于写入（writerIndex）。</p></blockquote><p>下面的例子详细说，不同ByteBuff的使用模式：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ByteBuffExample</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">HI_BYTE_BUFF</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Hi! ByteBuff.&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">heapBuff</span> <span class="hljs-operator">=</span> Unpooled.copiedBuffer(HI_BYTE_BUFF, CharsetUtil.UTF_8);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Charset</span> <span class="hljs-variable">UTF_8</span> <span class="hljs-operator">=</span> CharsetUtil.UTF_8;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// 堆缓冲区</span><br>        System.out.println(<span class="hljs-string">&quot;==================heap buff==================&quot;</span>);<br>        heapByteBuff();<br>        System.out.println(<span class="hljs-string">&quot;==================direct buff==================&quot;</span>);<br>        directByteBuff();<br>        System.out.println(<span class="hljs-string">&quot;==================composite buff==================&quot;</span>);<br>        compositeByteBuff();<br>        System.out.println(<span class="hljs-string">&quot;==================read and write==================&quot;</span>);<br>        readAndWrite();<br>        System.out.println(<span class="hljs-string">&quot;==================ByteBufHolder==================&quot;</span>);<br>        byteBuffHolder();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 存储在 JVM 堆空间中，这种模式被成为支撑数据（backing array）</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">heapByteBuff</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (heapBuff.hasArray()) &#123;<br>            <span class="hljs-type">byte</span>[] array = heapBuff.array();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> heapBuff.arrayOffset() + heapBuff.readerIndex();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> heapBuff.readableBytes();<br>            <span class="hljs-type">byte</span>[] target = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[length];<br>            System.arraycopy(array, offset, target, <span class="hljs-number">0</span>, length);<br>            System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(target));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 直接缓冲区是另外一种ByteBuf模式。</span><br><span class="hljs-comment">     * 我们期望用于对象创建的内存分配永远都来自于堆中，</span><br><span class="hljs-comment">     * 但这并不是必须的——NIO在JDK1.4中引入的ByteBuffer类允许JVM实现通过本地调用来分配内存。</span><br><span class="hljs-comment">     * 这主要是为了避免在每次调用本地I/O操作之前（或者之后）</span><br><span class="hljs-comment">     * 将缓冲区的内容复制到一个中间缓冲区（或者从中间缓冲区把内容复制到缓冲区）。</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * 它的缺点主要：</span><br><span class="hljs-comment">     * 1. 分配和释放表昂贵</span><br><span class="hljs-comment">     * 2. 如果在处理预留代码的时候，可能不得不又复制一遍。</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * 建议：如果在知道数据将被作为数据来访问的时候，我们更加推荐使用 堆内存 。</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">directByteBuff</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">directBuffer</span> <span class="hljs-operator">=</span> Unpooled.directBuffer().writeBytes(heapBuff);<br>        <span class="hljs-comment">// 检查buf是否有数组，如果不是，则说明一个直接堆缓冲区</span><br>        <span class="hljs-keyword">if</span> (!directBuffer.hasArray()) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">readerIndex</span> <span class="hljs-operator">=</span> directBuffer.readerIndex();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> directBuffer.readableBytes();<br>            <span class="hljs-type">byte</span>[] array = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[length];<br>            directBuffer.getBytes(readerIndex, array);<br>            System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(array));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 复合缓冲区，它提供一种聚合模式给我们使用。例如我需要组合一个协议，</span><br><span class="hljs-comment">     * 我们需要一部分装配头部信息，一部分装配主体信息。</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">compositeByteBuff</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">CompositeByteBuf</span> <span class="hljs-variable">compositeByteBuf</span> <span class="hljs-operator">=</span> Unpooled.compositeBuffer();<br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">headBuf</span> <span class="hljs-operator">=</span> Unpooled.copiedBuffer(<span class="hljs-string">&quot;Hi! &quot;</span>, CharsetUtil.UTF_8);<br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">bodyBuf</span> <span class="hljs-operator">=</span> Unpooled.copiedBuffer(<span class="hljs-string">&quot;ByteBuff.&quot;</span>, CharsetUtil.UTF_8);<br>        compositeByteBuf.addComponents(headBuf, bodyBuf);<br>        System.out.println(<span class="hljs-string">&quot;compositeByteBuf.removeComponent(0) before:&quot;</span>);<br>        <span class="hljs-keyword">for</span> (ByteBuf byteBuf : compositeByteBuf) &#123;<br>            System.out.println(byteBuf.toString(CharsetUtil.UTF_8));<br>        &#125;<br>        System.out.println(<span class="hljs-string">&quot;compositeByteBuf.removeComponent(0) after:&quot;</span>);<br>        compositeByteBuf.removeComponent(<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">for</span> (ByteBuf byteBuf : compositeByteBuf) &#123;<br>            System.out.println(byteBuf.toString(CharsetUtil.UTF_8));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 主要是一些字节操作API的使用。</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readAndWrite</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">byteBuf</span> <span class="hljs-operator">=</span> Unpooled.copiedBuffer(HI_BYTE_BUFF, CharsetUtil.UTF_8);<br>        System.out.println(byteBuf.toString(CharsetUtil.UTF_8));<br>        <span class="hljs-comment">// slice，分片，但是不会修改索引信息</span><br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">slice</span> <span class="hljs-operator">=</span> byteBuf.slice(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>);<br>        <span class="hljs-comment">// 拷贝操作，不影响原对象</span><br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">copy</span> <span class="hljs-operator">=</span> byteBuf.copy(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>);<br>        <span class="hljs-keyword">assert</span> !ByteBufUtil.equals(slice, copy);<br>        System.out.println(slice.toString(CharsetUtil.UTF_8));<br>        byteBuf.setByte(<span class="hljs-number">0</span>, ((<span class="hljs-type">byte</span>) <span class="hljs-string">&#x27;J&#x27;</span>));<br>        copy.setByte(<span class="hljs-number">0</span>, ((<span class="hljs-type">byte</span>) <span class="hljs-string">&#x27;W&#x27;</span>));<br>        <span class="hljs-keyword">assert</span> byteBuf.getByte(<span class="hljs-number">0</span>) == slice.getByte(<span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">assert</span> copy.getByte(<span class="hljs-number">0</span>) != byteBuf.getByte(<span class="hljs-number">0</span>);<br>        System.out.println(((<span class="hljs-type">char</span>) byteBuf.getByte(<span class="hljs-number">0</span>)));<br>        <span class="hljs-type">int</span> <span class="hljs-variable">readerIndex</span> <span class="hljs-operator">=</span> byteBuf.readerIndex();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">writerIndex</span> <span class="hljs-operator">=</span> byteBuf.writerIndex();<br>        byteBuf.setByte(<span class="hljs-number">1</span>, ((<span class="hljs-type">byte</span>) <span class="hljs-string">&#x27;B&#x27;</span>));<br>        System.out.println(((<span class="hljs-type">char</span>) byteBuf.getByte(<span class="hljs-number">1</span>)));<br>        <span class="hljs-type">assert</span> <span class="hljs-variable">readerIndex</span> <span class="hljs-operator">=</span>= byteBuf.readerIndex();<br>        <span class="hljs-type">assert</span> <span class="hljs-variable">writerIndex</span> <span class="hljs-operator">=</span>= byteBuf.writerIndex();<br>        <span class="hljs-comment">// 写一个字节，将会影响writerIndex索引。</span><br>        byteBuf.writeByte(((<span class="hljs-type">byte</span>) <span class="hljs-string">&#x27;?&#x27;</span>));<br>        <span class="hljs-type">assert</span> <span class="hljs-variable">readerIndex</span> <span class="hljs-operator">=</span>= byteBuf.readerIndex();<br>        <span class="hljs-keyword">assert</span> writerIndex != byteBuf.writerIndex();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">byteBuffHolder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ByteBufHolder</span> <span class="hljs-variable">byteBufHolder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultByteBufHolder</span>(Unpooled.copiedBuffer(HI_BYTE_BUFF, UTF_8));<br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> byteBufHolder.copy().content();<br>        content.setByte(<span class="hljs-number">0</span>, ((<span class="hljs-type">byte</span>) <span class="hljs-string">&#x27;W&#x27;</span>));<br>        System.out.println(<span class="hljs-string">&quot;source: &quot;</span> + ((<span class="hljs-type">char</span>) heapBuff.getByte(<span class="hljs-number">0</span>)));<br>        System.out.println(<span class="hljs-string">&quot;new: &quot;</span> + ((<span class="hljs-type">char</span>) content.getByte(<span class="hljs-number">0</span>)));<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="解码器和编码器"><a href="#解码器和编码器" class="headerlink" title="解码器和编码器"></a>解码器和编码器</h3><h4 id="解码器"><a href="#解码器" class="headerlink" title="解码器"></a>解码器</h4><p>总体来说，我们有两种需求：</p><ul><li>字节解码成消息，常用抽象类：ByteToMessageDecoder extends ChannelInboundHandlerAdapter</li><li>消息A解码成消息B，常用抽象类：MessageToMessageDecoder extends ChannelInboundHandlerAdapter<br>它们都是继承 ChannelInboundHandlerAdapter，又是熟悉的味道，这个又是得益Netty统一的设计。<br>流程图如下：<br><img src="https://s2.ax1x.com/2020/02/07/1gv0E9.png" srcset="/img/loading.gif" lazyload alt="1gv0E9.png"></li></ul><h4 id="编码器"><a href="#编码器" class="headerlink" title="编码器"></a>编码器</h4><p>总体来说，我们有两种需求：</p><ul><li>消息编码成消息，常用抽象类：MessageToByteEncoder extends ChannelOutboundHandlerAdapter</li><li>消息B编码成消息A，常用抽象类：MessageToMessageEncoder extends ChannelOutboundHandlerAdapter<br>它们都是继承了ChannelOutboundHandlerAdapter。<br>流程图如下：<br><img src="https://s2.ax1x.com/2020/02/07/1gzNTJ.png" srcset="/img/loading.gif" lazyload alt="1gzNTJ.png"></li></ul><h4 id="抽象的编解码类"><a href="#抽象的编解码类" class="headerlink" title="抽象的编解码类"></a>抽象的编解码类</h4><p>很多时候，编解码是一对，我们就想着为啥不能直接设置成一个类？Netty给我们，预设Codec。</p><ul><li>字节编解码成消息，ByteToMessageCodec extend ChannelDuplexHandler</li><li>消息编解码成消息，MessageToMessageCodec extend ChannelDuplexHandler<br>ChannelDuplexHandler extends ChannelInboundHandlerAdapter implements ChannelOutboundHandler</li></ul><h4 id="HttpObjectAggregator-源码分析"><a href="#HttpObjectAggregator-源码分析" class="headerlink" title="HttpObjectAggregator 源码分析"></a>HttpObjectAggregator 源码分析</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">HttpObjectAggregator<br>        <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MessageAggregator</span>&lt;HttpObject, HttpMessage, HttpContent, FullHttpMessage&gt;<br></code></pre></td></tr></table></figure><p>核心逻辑其实是在 MessageAggregator 中 decode 方法中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decode</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ChannelHandlerContext ctx, I msg, List&lt;Object&gt; out)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">assert</span> aggregating;<br>        <span class="hljs-comment">// HttpObjectAggregator.isStartMessage:</span><br>        <span class="hljs-comment">// return msg instanceof HttpMessage;</span><br>        <span class="hljs-keyword">if</span> (isStartMessage(msg)) &#123;<br>            handlingOversizedMessage = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">if</span> (currentMessage != <span class="hljs-literal">null</span>) &#123;<br>                currentMessage.release();<br>                currentMessage = <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageAggregationException</span>();<br>            &#125;<br><br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            <span class="hljs-type">S</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> (S) msg;<br><br>            <span class="hljs-comment">// Send the continue response if necessary (e.g. &#x27;Expect: 100-continue&#x27; header)</span><br>            <span class="hljs-comment">// Check before content length. Failing an expectation may result in a different response being sent.</span><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">continueResponse</span> <span class="hljs-operator">=</span> newContinueResponse(m, maxContentLength, ctx.pipeline());<br>            <span class="hljs-keyword">if</span> (continueResponse != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// Cache the write listener for reuse.</span><br>                <span class="hljs-comment">// 缓存起来监听器方便重用，监听器作用：如果调用不成功，则调用fireExceptionCaught方法，抛出异常</span><br>                <span class="hljs-type">ChannelFutureListener</span> <span class="hljs-variable">listener</span> <span class="hljs-operator">=</span> continueResponseWriteListener;<br>                <span class="hljs-keyword">if</span> (listener == <span class="hljs-literal">null</span>) &#123;<br>                    continueResponseWriteListener = listener = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelFutureListener</span>() &#123;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">operationComplete</span><span class="hljs-params">(ChannelFuture future)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                            <span class="hljs-keyword">if</span> (!future.isSuccess()) &#123;<br>                                ctx.fireExceptionCaught(future.cause());<br>                            &#125;<br>                        &#125;<br>                    &#125;;<br>                &#125;<br><br>                <span class="hljs-comment">// Make sure to call this before writing, otherwise reference counts may be invalid.</span><br>                <span class="hljs-type">boolean</span> <span class="hljs-variable">closeAfterWrite</span> <span class="hljs-operator">=</span> closeAfterContinueResponse(continueResponse);<br>                handlingOversizedMessage = ignoreContentAfterContinueResponse(continueResponse);<br><br>                <span class="hljs-keyword">final</span> <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">future</span> <span class="hljs-operator">=</span> ctx.writeAndFlush(continueResponse).addListener(listener);<br><br>                <span class="hljs-keyword">if</span> (closeAfterWrite) &#123;<br>                    future.addListener(ChannelFutureListener.CLOSE);<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (handlingOversizedMessage) &#123;<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isContentLengthInvalid(m, maxContentLength)) &#123;<br>                <span class="hljs-comment">// if content length is set, preemptively close if it&#x27;s too large</span><br>                invokeHandleOversizedMessage(ctx, m);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> DecoderResultProvider &amp;&amp; !((DecoderResultProvider) m).decoderResult().isSuccess()) &#123;<br>                O aggregated;<br>                <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> ByteBufHolder) &#123;<br>                    <span class="hljs-comment">// retain方法：将引用增加+1（Netty中，如果引用值为0，则会被回收），以防止被回收</span><br>                    <span class="hljs-comment">// 开始聚合操作由子类实现对应的操作</span><br>                    aggregated = beginAggregation(m, ((ByteBufHolder) m).content().retain());<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    aggregated = beginAggregation(m, EMPTY_BUFFER);<br>                &#125;<br>                <span class="hljs-comment">// 完成聚合操作，finishAggregation0 中调用了 finishAggregation,其中finishAggregation由子类实现。</span><br>                <span class="hljs-comment">// HttpObjectAggregator中实现了，增加了rfc2616 14.13 Content-Length 判断，如果没有响应体头部那样设置 &#x27;Content-Length&#x27;，则根据 aggregated.content().readableBytes() 设置一个值</span><br>                finishAggregation0(aggregated);<br>                out.add(aggregated);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// A streamed message - initialize the cumulative buffer, and wait for incoming chunks.</span><br>            <span class="hljs-type">CompositeByteBuf</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> ctx.alloc().compositeBuffer(maxCumulationBufferComponents);<br>            <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> ByteBufHolder) &#123;<br>                appendPartialContent(content, ((ByteBufHolder) m).content());<br>            &#125;<br>            currentMessage = beginAggregation(m, content);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isContentMessage(msg)) &#123;<br>            <span class="hljs-keyword">if</span> (currentMessage == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// it is possible that a TooLongFrameException was already thrown but we can still discard data</span><br>                <span class="hljs-comment">// until the begging of the next request/response.</span><br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// Merge the received chunk into the content of the current message.</span><br>            <span class="hljs-type">CompositeByteBuf</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> (CompositeByteBuf) currentMessage.content();<br><br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">C</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> (C) msg;<br>            <span class="hljs-comment">// Handle oversized message.</span><br>            <span class="hljs-keyword">if</span> (content.readableBytes() &gt; maxContentLength - m.content().readableBytes()) &#123;<br>                <span class="hljs-comment">// By convention, full message type extends first message type.</span><br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                <span class="hljs-type">S</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> (S) currentMessage;<br>                invokeHandleOversizedMessage(ctx, s);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// Append the content of the chunk.</span><br>            appendPartialContent(content, m.content());<br><br>            <span class="hljs-comment">// Give the subtypes a chance to merge additional information such as trailing headers.</span><br>            aggregate(currentMessage, m);<br><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> last;<br>            <span class="hljs-comment">// 主要判断 是否为 最后的消息了，如果是最后的消息，将进行添加输出列表out中</span><br>            <span class="hljs-keyword">if</span> (m <span class="hljs-keyword">instanceof</span> DecoderResultProvider) &#123;<br>                <span class="hljs-type">DecoderResult</span> <span class="hljs-variable">decoderResult</span> <span class="hljs-operator">=</span> ((DecoderResultProvider) m).decoderResult();<br>                <span class="hljs-keyword">if</span> (!decoderResult.isSuccess()) &#123;<br>                    <span class="hljs-keyword">if</span> (currentMessage <span class="hljs-keyword">instanceof</span> DecoderResultProvider) &#123;<br>                        ((DecoderResultProvider) currentMessage).setDecoderResult(<br>                                DecoderResult.failure(decoderResult.cause()));<br>                    &#125;<br>                    last = <span class="hljs-literal">true</span>;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    last = isLastContentMessage(m);<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                last = isLastContentMessage(m);<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (last) &#123;<br>                finishAggregation0(currentMessage);<br><br>                <span class="hljs-comment">// All done</span><br>                out.add(currentMessage);<br>                currentMessage = <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageAggregationException</span>();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><h3 id="不可被忽略的单元测试"><a href="#不可被忽略的单元测试" class="headerlink" title="不可被忽略的单元测试"></a>不可被忽略的单元测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * AbsIntegerEncoder 测试类</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> jaryoung.com</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020-02-02 21:26</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbsIntegerEncoder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MessageToMessageEncoder</span>&lt;ByteBuf&gt; &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">encode</span><span class="hljs-params">(ChannelHandlerContext ctx, ByteBuf msg, List&lt;Object&gt; out)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>            <span class="hljs-comment">// 这里就是我犯下的低级错误，当时没有想明白，为啥是4呢？</span><br>            <span class="hljs-comment">// 如果我们知道int是占4个字节，就很容易理解了。</span><br>            <span class="hljs-comment">// 也是从这里，让我反思。</span><br>        <span class="hljs-keyword">while</span> (msg.readableBytes() &gt;= <span class="hljs-number">4</span>) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> Math.abs(msg.readInt());<br>            out.add(value);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbsIntegerEncoderTest</span> &#123;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testAbsIntegerEncoder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">byteBuf</span> <span class="hljs-operator">=</span> Unpooled.buffer();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            byteBuf.writeInt(i * -<span class="hljs-number">1</span>);<br>        &#125;<br>        <span class="hljs-type">EmbeddedChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EmbeddedChannel</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AbsIntegerEncoder</span>());<br>        Assert.assertTrue(channel.writeOutbound(byteBuf));<br>        Assert.assertTrue(channel.finish());<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            Assert.assertEquals(i, ((<span class="hljs-type">int</span>) channel.readOutbound()));<br>        &#125;<br>        Assert.assertNull(channel.readOutbound());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 自定义待测试待 解码器</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> jaryoung.com</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020-02-02 20:56</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FixedLengthFrameDecoder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ByteToMessageDecoder</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> frameLength;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">FixedLengthFrameDecoder</span><span class="hljs-params">(<span class="hljs-type">int</span> frameLength)</span> &#123;<br>        <span class="hljs-keyword">if</span> (frameLength &lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;frameLength must be a positive integer: &quot;</span> + frameLength);<br>        &#125;<br>        <span class="hljs-built_in">this</span>.frameLength = frameLength;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decode</span><span class="hljs-params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">while</span> (in.readableBytes() &gt;= frameLength) &#123;<br>            <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> in.readBytes(frameLength);<br>            out.add(buf);<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FrameChunkDecoderTest</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFrameChunkDecoderException</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">byteBuf</span> <span class="hljs-operator">=</span> Unpooled.buffer();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>            byteBuf.writeByte(i);<br>        &#125;<br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> byteBuf.duplicate();<br>        <span class="hljs-type">EmbeddedChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EmbeddedChannel</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FrameChunkDecoder</span>(<span class="hljs-number">3</span>));<br>        Assert.assertTrue(channel.writeInbound(input.readBytes(<span class="hljs-number">2</span>)));<br>        <span class="hljs-keyword">try</span> &#123;<br>            channel.writeInbound(input.readBytes(<span class="hljs-number">4</span>));<br>            Assert.fail();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            Assert.assertTrue(e <span class="hljs-keyword">instanceof</span> TooLongFrameException);<br>        &#125;<br>        Assert.assertTrue(channel.writeInbound(input.readBytes(<span class="hljs-number">3</span>)));<br><br>        Assert.assertTrue(channel.finish());<br><br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">read</span> <span class="hljs-operator">=</span> channel.readInbound();<br>        Assert.assertEquals(byteBuf.readSlice(<span class="hljs-number">2</span>), read);<br>        read.release();<br><br>        read = channel.readInbound();<br>        Assert.assertEquals(byteBuf.skipBytes(<span class="hljs-number">4</span>).readSlice(<span class="hljs-number">3</span>), read);<br>        read.release();<br><br>        Assert.assertNull(channel.readInbound());<br>        byteBuf.release();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="网络协议"><a href="#网络协议" class="headerlink" title="网络协议"></a>网络协议</h2><h3 id="使用WebSocket"><a href="#使用WebSocket" class="headerlink" title="使用WebSocket"></a>使用WebSocket</h3><blockquote><p>WebSocket ，WebSocket协议是完全重新设计的协议，旨在为Web上的双向数据传输问题提供一个切实可行的解决方案，使得客户端和服务器之间可以在任意时刻传输消息，因此，这也就要求它们异步地处理消息回执。</p></blockquote><p>使用WebSocket实现一个简单的聊天室，总体架构图如下：<br><img src="https://s2.ax1x.com/2020/02/07/12ZsXj.png" srcset="/img/loading.gif" lazyload alt="12ZsXj.png"><br>服务器的流程图如下：<br><img src="https://s2.ax1x.com/2020/02/07/12Z6ns.png" srcset="/img/loading.gif" lazyload alt="12Z6ns.png"></p><p>大概代码结构如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs code">src<br>├─main<br>    ├─java<br>        ├─handler<br>            ├─HttpRequestHandler<br>            ├─TextWebSocketFrameHandler<br>        ├─initializer<br>            ├─ChatServerInitializer<br>            ├─SecureChatServerInitializer<br>        ├─server<br>            ├─ChatServer<br>            ├─SecureChatServer<br>    ├─resource<br>    ├─index.html<br>├─test<br>├─pom.xml<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> io.netty.channel.*;<br><span class="hljs-keyword">import</span> io.netty.handler.codec.http.*;<br><span class="hljs-keyword">import</span> io.netty.handler.ssl.SslHandler;<br><span class="hljs-keyword">import</span> io.netty.handler.stream.ChunkedNioFile;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.FileNotFoundException;<br><span class="hljs-keyword">import</span> java.io.RandomAccessFile;<br><span class="hljs-keyword">import</span> java.net.URISyntaxException;<br><span class="hljs-keyword">import</span> java.net.URL;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * HttpRequestHandler</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> jaryoung.com</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020-02-05 15:25</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpRequestHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;FullHttpRequest&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String wsUri;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> File INDEX;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-type">URL</span> <span class="hljs-variable">location</span> <span class="hljs-operator">=</span> HttpRequestHandler.class.getProtectionDomain().getCodeSource().getLocation();<br>        String path;<br>        <span class="hljs-keyword">try</span> &#123;<br>            path = location.toURI() + <span class="hljs-string">&quot;index.html&quot;</span>;<br>            path = !path.contains(<span class="hljs-string">&quot;file:&quot;</span>) ? path : path.substring(<span class="hljs-number">5</span>);<br>            INDEX = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(path);<br>            <span class="hljs-keyword">if</span> (!INDEX.exists()) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileNotFoundException</span>(<span class="hljs-string">&quot;path :&quot;</span> + path + <span class="hljs-string">&quot; not found&quot;</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (URISyntaxException | FileNotFoundException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HttpRequestHandler</span><span class="hljs-params">(String wsUri)</span> &#123;<br>        <span class="hljs-built_in">this</span>.wsUri = wsUri;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, FullHttpRequest request)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (wsUri.equalsIgnoreCase(request.uri())) &#123;<br>            ctx.fireChannelRead(request.retain());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">if</span> (HttpUtil.is100ContinueExpected(request)) &#123;<br>                send100Continue(ctx);<br>            &#125;<br>            <span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(INDEX, <span class="hljs-string">&quot;r&quot;</span>);<br>            <span class="hljs-type">HttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultHttpResponse</span>(request.protocolVersion(), HttpResponseStatus.OK);<br>            response.headers().set(HttpHeaderNames.CONTENT_TYPE, <span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span>);<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">keepAlive</span> <span class="hljs-operator">=</span> HttpUtil.isKeepAlive(request);<br>            <span class="hljs-keyword">if</span> (keepAlive) &#123;<br>                response.headers().set(HttpHeaderNames.CONTENT_LENGTH, file.length());<br>                response.headers().set(HttpHeaderNames.CONNECTION, HttpHeaderValues.KEEP_ALIVE);<br>            &#125;<br>            ctx.write(response);<br>            <span class="hljs-keyword">if</span> (ctx.pipeline().get(SslHandler.class) == <span class="hljs-literal">null</span>) &#123;<br>                ctx.write(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultFileRegion</span>(file.getChannel(), <span class="hljs-number">0</span>, file.length()));<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                ctx.write(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChunkedNioFile</span>(file.getChannel()));<br>            &#125;<br>            <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">future</span> <span class="hljs-operator">=</span> ctx.writeAndFlush(LastHttpContent.EMPTY_LAST_CONTENT);<br>            <span class="hljs-keyword">if</span> (!keepAlive) &#123;<br>                future.addListener(ChannelFutureListener.CLOSE);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">send100Continue</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> &#123;<br>        <span class="hljs-type">FullHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1, HttpResponseStatus.CONTINUE);<br>        ctx.writeAndFlush(response);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        cause.printStackTrace();<br>        ctx.close();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;<br><span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;<br><span class="hljs-keyword">import</span> io.netty.channel.group.ChannelGroup;<br><span class="hljs-keyword">import</span> io.netty.handler.codec.http.websocketx.TextWebSocketFrame;<br><span class="hljs-keyword">import</span> io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * TextWebSocketFrameHandler</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> jaryoung.com</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020-02-05 15:58</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TextWebSocketFrameHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;TextWebSocketFrame&gt; &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChannelGroup group;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TextWebSocketFrameHandler</span><span class="hljs-params">(ChannelGroup group)</span> &#123;<br>        <span class="hljs-built_in">this</span>.group = group;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">userEventTriggered</span><span class="hljs-params">(ChannelHandlerContext ctx, Object evt)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">if</span> (evt <span class="hljs-keyword">instanceof</span> WebSocketServerProtocolHandler.HandshakeComplete) &#123;<br>            ctx.pipeline().remove(HttpRequestHandler.class);<br>            group.writeAndFlush(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextWebSocketFrame</span>(<span class="hljs-string">&quot;Client &quot;</span> + ctx.channel() + <span class="hljs-string">&quot; joined&quot;</span>));<br>            group.add(ctx.channel());<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">super</span>.userEventTriggered(ctx, evt);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, TextWebSocketFrame msg)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        group.writeAndFlush(msg.retain());<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> io.netty.channel.Channel;<br><span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;<br><span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;<br><span class="hljs-keyword">import</span> io.netty.channel.group.ChannelGroup;<br><span class="hljs-keyword">import</span> io.netty.example.ws.handler.HttpRequestHandler;<br><span class="hljs-keyword">import</span> io.netty.example.ws.handler.TextWebSocketFrameHandler;<br><span class="hljs-keyword">import</span> io.netty.handler.codec.http.HttpObjectAggregator;<br><span class="hljs-keyword">import</span> io.netty.handler.codec.http.HttpServerCodec;<br><span class="hljs-keyword">import</span> io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler;<br><span class="hljs-keyword">import</span> io.netty.handler.logging.LogLevel;<br><span class="hljs-keyword">import</span> io.netty.handler.logging.LoggingHandler;<br><span class="hljs-keyword">import</span> io.netty.handler.stream.ChunkedWriteHandler;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ChatServerInitializer</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> jaryoung.com</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020-02-05 16:08</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatServerInitializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;Channel&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChannelGroup group;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatServerInitializer</span><span class="hljs-params">(ChannelGroup group)</span> &#123;<br>        <span class="hljs-built_in">this</span>.group = group;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(Channel ch)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> ch.pipeline();<br>        pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpServerCodec</span>())<br>                .addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChunkedWriteHandler</span>())<br>                .addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpObjectAggregator</span>(<span class="hljs-number">64</span> * <span class="hljs-number">1024</span>))<br>                .addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpRequestHandler</span>(<span class="hljs-string">&quot;/ws&quot;</span>))<br>                .addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocketServerProtocolHandler</span>(<span class="hljs-string">&quot;/ws&quot;</span>))<br>                .addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextWebSocketFrameHandler</span>(group))<br>                .addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoggingHandler</span>(LogLevel.INFO))<br>        ;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> io.netty.channel.Channel;<br><span class="hljs-keyword">import</span> io.netty.channel.group.ChannelGroup;<br><span class="hljs-keyword">import</span> io.netty.handler.ssl.SslContext;<br><span class="hljs-keyword">import</span> io.netty.handler.ssl.SslHandler;<br><br><span class="hljs-keyword">import</span> javax.net.ssl.SSLEngine;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * SecureChatServerInitializer</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> jaryoung.com</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020-02-05 21:38</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecureChatServerInitializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChatServerInitializer</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SslContext sslContext;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SecureChatServerInitializer</span><span class="hljs-params">(ChannelGroup channelGroup, SslContext sslContext)</span> &#123;<br>        <span class="hljs-built_in">super</span>(channelGroup);<br>        <span class="hljs-built_in">this</span>.sslContext = sslContext;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(Channel ch)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-built_in">super</span>.initChannel(ch);<br>        <span class="hljs-type">SSLEngine</span> <span class="hljs-variable">engine</span> <span class="hljs-operator">=</span> sslContext.newHandler(ch.alloc()).engine();<br>        engine.setUseClientMode(<span class="hljs-literal">false</span>);<br>        ch.pipeline().addFirst(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SslHandler</span>(engine));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;<br><span class="hljs-keyword">import</span> io.netty.channel.Channel;<br><span class="hljs-keyword">import</span> io.netty.channel.ChannelFuture;<br><span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;<br><span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;<br><span class="hljs-keyword">import</span> io.netty.channel.group.ChannelGroup;<br><span class="hljs-keyword">import</span> io.netty.channel.group.DefaultChannelGroup;<br><span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;<br><span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;<br><span class="hljs-keyword">import</span> io.netty.example.ws.initializer.ChatServerInitializer;<br><span class="hljs-keyword">import</span> io.netty.util.concurrent.ImmediateEventExecutor;<br><span class="hljs-keyword">import</span> org.slf4j.Logger;<br><span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<br><br><span class="hljs-keyword">import</span> java.net.InetSocketAddress;<br><span class="hljs-keyword">import</span> java.util.Objects;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ChatServer</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> jaryoung.com</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020-02-05 16:29</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatServer</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ChannelGroup</span> <span class="hljs-variable">channelGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultChannelGroup</span>(ImmediateEventExecutor.INSTANCE);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">private</span> Channel channel;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">SERVER_PORT</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;port&quot;</span>, <span class="hljs-string">&quot;9999&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(ChatServer.class);<br><br>    <span class="hljs-keyword">protected</span> ChannelFuture <span class="hljs-title function_">start</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> Integer.parseInt(SERVER_PORT);<br>        <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">serverBootstrap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();<br>        serverBootstrap.group(bossGroup, workGroup)<br>                .channel(NioServerSocketChannel.class)<br>                .childHandler(createInitializer(channelGroup));<br>        <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">future</span> <span class="hljs-operator">=</span> serverBootstrap.bind(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(port));<br>        future.syncUninterruptibly();<br>        channel = future.channel();<br>        Runtime.getRuntime().addShutdownHook(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-built_in">this</span>::destroy));<br>        Objects.requireNonNull(future).channel().closeFuture().syncUninterruptibly();<br>        <span class="hljs-keyword">if</span> (future.isSuccess()) &#123;<br>            logger.info(<span class="hljs-string">&quot;Chat Server start, port: &#123;&#125;&quot;</span>, port);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            logger.info(<span class="hljs-string">&quot;Chat Server start failed, port: &#123;&#125;&quot;</span>, port);<br>        &#125;<br>        <span class="hljs-keyword">return</span> future;<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> ChannelInitializer&lt;Channel&gt; <span class="hljs-title function_">createInitializer</span><span class="hljs-params">(ChannelGroup channelGroup)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatServerInitializer</span>(channelGroup);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (channel != <span class="hljs-literal">null</span>) &#123;<br>            channel.close();<br>        &#125;<br>        channelGroup.close();<br>        bossGroup.shutdownGracefully();<br>        workGroup.shutdownGracefully();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatServer</span>().start();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> io.netty.channel.Channel;<br><span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;<br><span class="hljs-keyword">import</span> io.netty.channel.group.ChannelGroup;<br><span class="hljs-keyword">import</span> io.netty.example.ws.initializer.SecureChatServerInitializer;<br><span class="hljs-keyword">import</span> io.netty.handler.ssl.SslContext;<br><span class="hljs-keyword">import</span> io.netty.handler.ssl.SslContextBuilder;<br><span class="hljs-keyword">import</span> io.netty.handler.ssl.util.SelfSignedCertificate;<br><br><span class="hljs-keyword">import</span> javax.net.ssl.SSLException;<br><span class="hljs-keyword">import</span> java.security.cert.CertificateException;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * SecureChatServer</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> jaryoung.com</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020-02-05 21:35</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.0.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SecureChatServer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChatServer</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SslContext sslContext;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SecureChatServer</span><span class="hljs-params">(SslContext sslContext)</span> &#123;<br>        <span class="hljs-built_in">this</span>.sslContext = sslContext;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> ChannelInitializer&lt;Channel&gt; <span class="hljs-title function_">createInitializer</span><span class="hljs-params">(ChannelGroup channelGroup)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecureChatServerInitializer</span>(channelGroup, sslContext);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">SelfSignedCertificate</span> <span class="hljs-variable">certificate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SelfSignedCertificate</span>();<br>            <span class="hljs-type">SslContext</span> <span class="hljs-variable">sslContext</span> <span class="hljs-operator">=</span> SslContextBuilder.forServer(certificate.certificate(), certificate.privateKey()).build();<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecureChatServer</span>(sslContext).start();<br>        &#125; <span class="hljs-keyword">catch</span> (SSLException | CertificateException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="最后聊聊"><a href="#最后聊聊" class="headerlink" title="最后聊聊"></a>最后聊聊</h2><p>连续差不多两周的学习，通过看书+练习的操作，让自己能够将书上的知识，真的运用起来，并且进一步加深理解。<br>刻意练习真的太重要，如果光看不练，就是纸上谈兵。</p></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Read/" class="category-chain-item">Read</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/Netty/">#Netty</a> <a href="/tags/Java/">#Java</a></div></div><div class="license-box iconfont"><div class="license-title"><div>《Netty in Action》 读后感</div><div>https://jaryoung.com/2020/02/07/Netty-in-Action-After-Reading/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>Jerry Wu</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2020年2月7日 21:59</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2022年2月9日 11:19</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div></div><div class="post-prevnext"><article class="post-prev col-6"><a href="/2020/03/08/Hystrix-How-it-Works/" title="Hystrix 是如何工作？（翻译）"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Hystrix 是如何工作？（翻译）</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2020/01/04/Google-Elite-Security-Team-Project-Zero/" title="Google&#39;s Elite Security Team, Project Zero"><span class="hidden-mobile">Google&#39;s Elite Security Team, Project Zero</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js",(function(){var i=Object.assign({appId:"AVw7kqBWv8BqLExXq2drwbG3-gzGzoHsz",appKey:"I6ePpCb4W1A02o7TIXkrgrPX",path:"window.location.pathname",placeholder:"记得留下你的昵称和邮箱，可以快速收到回復～",avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!0,recordIP:!0,serverURLs:"",emojiCDN:null,emojiMaps:null,enableQQ:!0},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var i="#valine .vcontent img:not(.vemoji)";Fluid.plugins.initImageCaption(i),Fluid.plugins.initFancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="d-none d-lg-block col-lg-2"><div class="toc-container" id="toc-ctn" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></div></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a><div style="font-size:.85rem"><span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span><script src="/js/duration.js"></script></div></div><div class="statistics"><span id="leancloud-site-pv-container" style="display:none">总访问量 <span id="leancloud-site-pv"></span> 次 </span><span id="leancloud-site-uv-container" style="display:none">总访客数 <span id="leancloud-site-uv"></span> 人</span></div><span id="cnzz_stat_icon_1280822839" style="display:none"></span></div></footer><script src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/local-search.js"></script><script src="/js/img-lazyload.js"></script><script src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script><script defer src="/js/leancloud.js"></script><script defer>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?30a17f235b72eb0b6b00ebd50502c5a2";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script defer>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-219214701-1","auto"),ga("send","pageview")</script><script async src="https://www.google-analytics.com/analytics.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=302173009"></script><script defer>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","302173009")</script><script defer src="//s4.cnzz.com/z_stat.php?id=1280822839&show=pic" type="text/javascript"></script><script src="/js/boot.js"></script><script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>