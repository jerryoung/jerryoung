<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>《Netty in Action》 读后感 | 程序猿清丰</title><meta name="keywords" content="Java,Netty"><meta name="author" content="Jerry Wu"><meta name="copyright" content="Jerry Wu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="开编我想说 刻意练习，本着课本的例子，照着我也写一遍的原则进行练习。    基础知识真的太重要，很多基础知识是会影响我们阅读书的效果，甚至可能会误解书本的原意。就拿着当前阅读的书来说起，如果我们不知道计算机操作系统基础，不知Java网络编程基础，不知网络协议等，那么我们看书可能会举步维艰。所以，在看本书之前，我尝试查阅一些相关资料，以补充能够更好吸收书本知识。   本文章，就是书本很多地方的内容，"><meta property="og:type" content="article"><meta property="og:title" content="《Netty in Action》 读后感"><meta property="og:url" content="https://jaryoung.com/2020/02/07/Netty-in-Action-After-Reading/index.html"><meta property="og:site_name" content="程序猿清丰"><meta property="og:description" content="开编我想说 刻意练习，本着课本的例子，照着我也写一遍的原则进行练习。    基础知识真的太重要，很多基础知识是会影响我们阅读书的效果，甚至可能会误解书本的原意。就拿着当前阅读的书来说起，如果我们不知道计算机操作系统基础，不知Java网络编程基础，不知网络协议等，那么我们看书可能会举步维艰。所以，在看本书之前，我尝试查阅一些相关资料，以补充能够更好吸收书本知识。   本文章，就是书本很多地方的内容，"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://s2.ax1x.com/2020/02/07/12Z6ns.png"><meta property="article:published_time" content="2020-02-07T13:59:12.000Z"><meta property="article:modified_time" content="2022-02-07T13:29:47.559Z"><meta property="article:author" content="Jerry Wu"><meta property="article:tag" content="Java"><meta property="article:tag" content="Netty"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://s2.ax1x.com/2020/02/07/12Z6ns.png"><link rel="shortcut icon" href="/images/icons/icon-16x16.png"><link rel="canonical" href="https://jaryoung.com/2020/02/07/Netty-in-Action-After-Reading/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//s4.cnzz.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="manifest" href="/manifest.json"><link rel="apple-touch-icon" sizes="180x180" href="/images/icons/icon-32x32.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/icons/icon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/icons/icon-16x16.png"><link rel="mask-icon" href="/images/icons/icon-32x32.png" color="#5bbad5"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.css" media="print" onload='this.media="all"'><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-4246138471118676",enable_page_level_ads:"true"})</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?30a17f235b72eb0b6b00ebd50502c5a2";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-219214701-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-219214701-1")</script><script async data-pjax="data-pjax" src="https://s4.cnzz.com/z_stat.php?id=1280822839&amp;web_id=1280822839"></script><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:600},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:50,languages:{author:"作者: Jerry Wu",link:"链接: ",source:"来源: 程序猿清丰",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery@2/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!0,isAnchor:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"《Netty in Action》 读后感",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2022-02-07 21:29:47"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme");"dark"===t?activateDarkMode():"light"===t&&activateLightMode();const o=saveToLocal.get("aside-status");void 0!==o&&("hide"===o?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><script src="/sw-register.js"></script><link rel="stylesheet" href="/css/my.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_2744905_iihiav2q76.css"><link rel="manifest" href="/manifest.json"><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="程序猿清丰" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/icons/icon-128x128.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data is-center"><div class="data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">13</div></a></div><div class="data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a></div><div class="data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-timeline"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://s2.ax1x.com/2020/02/07/12Z6ns.png)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">程序猿清丰</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw iconfont icon-timeline"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">《Netty in Action》 读后感</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-02-07T13:59:12.000Z" title="发表于 2020-02-07 21:59:12">2020-02-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-02-07T13:29:47.559Z" title="更新于 2022-02-07 21:29:47">2022-02-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Read/">Read</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>28分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" data-flag-title="《Netty in Action》 读后感"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2020/02/07/Netty-in-Action-After-Reading/#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/2020/02/07/Netty-in-Action-After-Reading/" itemprop="commentCount"></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="开编我想说"><a href="#开编我想说" class="headerlink" title="开编我想说"></a>开编我想说</h2><blockquote><p>刻意练习，本着课本的例子，照着我也写一遍的原则进行练习。</p></blockquote><p>基础知识真的太重要，很多基础知识是会影响我们阅读书的效果，甚至可能会误解书本的原意。就拿着当前阅读的书来说起，如果我们不知道计算机操作系统基础，不知Java网络编程基础，不知网络协议等，那么我们看书可能会举步维艰。所以，在看本书之前，我尝试查阅一些相关资料，以补充能够更好吸收书本知识。</p><p>本文章，就是书本很多地方的内容，并未能深刻理解，一本书的内容也不可能全部呈现。例如，零拷贝，各种网络协议的理解，例如tcp，udp协议等。很多基础内容，都感觉相对薄弱，所以日后需要加强基础的部分。<br>看完，你可能会有以下收获：<br>Netty核心组件、重新认识字节、关于Netty单元测试、编码器和解码器、WebSocket简单的聊天室</p><span id="more"></span><h2 id="阅读前的预习，大有裨益"><a href="#阅读前的预习，大有裨益" class="headerlink" title="阅读前的预习，大有裨益"></a>阅读前的预习，大有裨益</h2><ul><li>同步和异步的概念</li></ul><blockquote><p>同步，是一个可靠的有序操作，例如，有顺序执行操作A-&gt;操作B，如果操作A没有完成返回，操作B需要排队等候；反之，异步则相反无需等待，通常可以依靠回调或者事件的方式来进行操作的次序的问题。</p></blockquote><ul><li>堵塞和非堵塞</li></ul><blockquote><p>在进行阻塞操作时，当前线程会处于阻塞状态，无法从事其他任务，只有当条件就绪才能继续，比如 ServerSocket 新连接建立完毕，或数据读取、写入操作完成；而非阻塞则是不管 IO 操作是否结束，直接返回，相应操作在后台继续处理。</p></blockquote><ul><li><p>查询常见的I&#x2F;O模型：I&#x2F;O堵塞;I&#x2F;O非堵塞;I&#x2F;O复用；信号驱动I&#x2F;O；异步I&#x2F;O<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.ax1x.com/2020/02/07/1cIMQI.png" alt="1cIMQI.png"></p></li><li><p>用户空间和系统空间</p></li></ul><blockquote><p>现在操作系统都是采用虚拟存储器，那么对32位操作系统而言，它的寻址空间（虚拟存储空间）为4G（2的32次方）。操作系统的核心是内核，独立于普通的应用程序，可以访问受保护的内存空间，也有访问底层硬件设备的所有权限。为了保证用户进程不能直接操作内核（kernel），保证内核的安全，操心系统将虚拟空间划分为两部分，一部分为内核空间，一部分为用户空间。针对linux操作系统而言，将最高的1G字节（从虚拟地址0xC0000000到0xFFFFFFFF），供内核使用，称为内核空间，而将较低的3G字节（从虚拟地址0x00000000到0xBFFFFFFF），供各个进程使用，称为用户空间。<a target="_blank" rel="noopener" href="https://yuelng.github.io/2018/03/16/computer_science/network_coding/">摘抄自这里</a></p></blockquote><ul><li>Linux 操作系统中select、poll、epoll<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/binarylei/p/11130079.html#select-api">详细内容可以查看</a></li><li>High-Performance I&#x2F;O Design Patterns<br><a target="_blank" rel="noopener" href="https://www.artima.com/articles/io_design_patterns.html">详细内容可以看</a></li></ul><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><blockquote><p>Netty is an asynchronous event-driven network application framework<br>for rapid development of maintainable high performance protocol servers &amp; clients.</p></blockquote><p>从上面我抽取了三个关键词，asynchronous、event-driven、high performance。带着三个关键信息，看能够从书中摄取到三个核心的内容。</p><h2 id="核心内容"><a href="#核心内容" class="headerlink" title="核心内容"></a>核心内容</h2><h3 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h3><h4 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h4><blockquote><p>Channel，是出入站数据的载体，或者是网络中Socket抽象代表。<br>目的：Channel为了降低直接使用Java中Socket API的复杂度。</p></blockquote><p>Channel的生命周期：register-&gt;active-&gt;inactive-&gt;unregistred</p><h4 id="EventLoop"><a href="#EventLoop" class="headerlink" title="EventLoop"></a>EventLoop</h4><blockquote><p>用于处理连接的生命周期的中发生的事件</p></blockquote><p>Channel、EventLoop和EventLoopGroup的关系图<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.ax1x.com/2020/02/07/1czd5n.png" alt="1czd5n.png"></p><p>图中可以看到EventLoopGroup其实就具有多个EventLoop的组，EventLoop会在Channel的整个生命周期处理I&#x2F;O事件。<br>三者关系如下：</p><ul><li>一个EventLoopGroup包含一个或者多个EventLoop</li><li>一个EventLoop一个生命周期中，只和一个线程绑定</li><li>EventLoop所有I&#x2F;O处理事件，将有专用的线程处理</li><li>一个Channel生命周期，只会注册到一个EventLoop上</li><li>一个EventLoop可以会分配多个Channel</li></ul><p>得益于EventLoop是一个固定的线程处理，给定的Channel上的I&#x2F;O的处理将会在同一个线程处理，避免了不必要的线程切换上下文的开销；</p><p>下面来深入了解一下，EventLoop：<br>先通过类图去纵览<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.ax1x.com/2020/02/07/1guZWT.png" alt="1guZWT.png"></p><ul><li>java.util.concurrent<br>AbstractExecutorService主要是实现了ExecutorService接口，ScheduledExecutorService则是继承了ExecutorService；</li><li>io.netty.utilconcurrent<br>AbstractEventExecutor，继承了AbstractExecutorService类，并且实现EventExecutor接口，</li><li>io.netty.channel<br>EventLoop，继承了OrderedEventExecutor, EventLoopGroup，只有一个：EventLoopGroup parent()方法。<br>SingleThreadEventLoop，继承SingleThreadEventExecutor，并且实现EventLoop接口；<br>重头戏来了，NioEventLoop，是继承了SingleThreadEventLoop，正如上面所说的：<code>一个EventLoop一个生命周期中，只和一个线程绑定</code></li></ul><p>EventLoop的执行逻辑：<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.ax1x.com/2020/02/07/1g3qc6.png" alt="1g3qc6.png"></p><h4 id="ChannelPipeline"><a href="#ChannelPipeline" class="headerlink" title="ChannelPipeline"></a>ChannelPipeline</h4><blockquote><p>pipeline，意译为管道，ChannelPipeline，一看到这个名字，我们能够猜到它的作用就是类似管道的作用。<br>目的：为了提供ChannelHandler链式容器（ChannelHandler在下一节介绍）</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.ax1x.com/2020/02/07/1gpYkj.png" alt="1gpYkj.png"></p><p>本节，需要了解pipeline它的头部和尾部的概念，入站从头部第一个ChannelHandler先入，出站的时候从尾端端第一个ChannelHandler先开始流出。</p><p>顺便提一下，Channel一旦分配为ChannelPipeline后，是永久性操作，不能被修改。<br>通过 DefaultChannelPipeline 和 AbstractChannel 源代码分析，也能得到上面的结论：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AbstractChannel</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">AbstractChannel</span><span class="params">(Channel parent)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">        pipeline = newChannelPipeline();<span class="comment">// 新建分配一个ChannelPipeline</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DefaultChannelPipeline</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">DefaultChannelPipeline</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">        <span class="built_in">this</span>.channel = ObjectUtil.checkNotNull(channel, <span class="string">&quot;channel&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>最后，上面的设计使得，我们 <strong>变动（增删改）</strong> ChannelPipeline上的Handler也是相当方便的。</p><h4 id="ChannelHandler"><a href="#ChannelHandler" class="headerlink" title="ChannelHandler"></a>ChannelHandler</h4><blockquote><p>ChannelHandler，它充当了所有处理入站和出站数据的应用程序逻辑的容器。<br>ChannelHandler生命周期：added-&gt;removed (excption)<br>通过ChannelHandler再来看出入站的概念：<br>入站，就是数据流要进行我们的服务前置的业务处理。出站，就是我们需要返回数据流时候的后置业务处理。当然我们还是需要谨记，上一节的pipeline的头部和尾端的概念，不然会容易出或者入站的handler出现位置不对的情况。</p></blockquote><ul><li>ChannelInboundHandler 入站处理器接口，处理入站数据和状态变化<br>列出我在练习中常用的方法：</li></ul><table><thead><tr><th>类　　型</th><th>描　　述</th></tr></thead><tbody><tr><td>channelRegistered</td><td>当Channel已经注册到它的EventLoop并且能够处理I&#x2F;O时被调用</td></tr><tr><td>channelUnregistered</td><td>当Channel从它的EventLoop注销并且无法处理任何I&#x2F;O时被调用</td></tr><tr><td>channelActive</td><td>当Channel处于活动状态时被调用；Channel已经连接&#x2F;绑定并且已经就绪</td></tr><tr><td>channelInactive</td><td>当Channel离开活动状态并且不再连接它的远程节点时被调用</td></tr><tr><td>channelReadComplete</td><td>当Channel上的一个读操作完成时被调用</td></tr><tr><td>channelRead</td><td>当从Channel读取数据时被调用</td></tr><tr><td>userEventTriggered</td><td>当ChannelnboundHandler.fireUserEventTriggered()方法被调用时被调用，因为一个POJO被传经了ChannelPipeline</td></tr></tbody></table><p>我们可以通过继承 ChannelInboundHandlerAdapter 来编写自己的入站处理器。常用的是：SimpleChannelInboundHandler，因为它给我优化了一些常用的操作，例如，资源的自动释放等</p><p>异常处理：<br>exceptionCaught，这个方法在 ChannelInboundHandlerAdapter 已经标记被弃用，</p><ul><li>ChannelOutboundHandler 出站处理器接口，处理出站的所有数据，并且能够拦截所有的操作。<br>列出我在练习中常用的方法：</li></ul><table><thead><tr><th>类　　型</th><th>描　　述</th></tr></thead><tbody><tr><td>bind(ChannelHandlerContext,SocketAddress,ChannelPromise)</td><td>当请求将Channel绑定到本地地址时被调用</td></tr><tr><td>connect(ChannelHandlerContext,SocketAddress,SocketAddress,ChannelPromise)当</td><td>请求将Channel连接到远程节点时被调用</td></tr><tr><td>disconnect(ChannelHandlerContext,ChannelPromise)</td><td>当请求将Channel从远程节点断开时被调用</td></tr><tr><td>close(ChannelHandlerContext,ChannelPromise)</td><td>当请求关闭Channel时被调用</td></tr><tr><td>deregister(ChannelHandlerContext,ChannelPromise)</td><td>当请求将Channel从它的EventLoop注销时被调用</td></tr><tr><td>read(ChannelHandlerContext)</td><td>当请求从Channel读取更多的数据时被调用</td></tr><tr><td>flush(ChannelHandlerContext)</td><td>当请求通过Channel将入队数据冲刷到远程节点时被调用</td></tr><tr><td>write(ChannelHandlerContext,Object,ChannelPromise)</td><td>当请求通过Channel将数据写到远程节点时被调用</td></tr></tbody></table><p>异常处理：<br>两种方式：</p><ol><li>在出站操作都会返回ChannelFuture，进行添加监听事件</li><li>在ChannelOutboundHandler的入参都会带有ChannelPromis，进行添加监听事件<br>方式2更加常用，因为相对方式1相关更加简单有效。</li></ol><h4 id="ChannelHandlerContext"><a href="#ChannelHandlerContext" class="headerlink" title="ChannelHandlerContext"></a>ChannelHandlerContext</h4><p>紧接上面，我来看一下Channel、ChannelPipeline、ChannelHandler和ChannelHandlerContext之间的关系：<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.ax1x.com/2020/02/07/123uKf.png" alt="123uKf.png"><br>当ChannelHandler添加到ChannelPipeline到时候，ChannelHandlerContext将会被创建。</p><p>ChannelHandler高级用法：我们可以在使用ChannelHandler可以缓存ChannelHanlderContext，然后去完成一些复杂的操作。<br>但是这里是有一个前提，就是当前ChannelHandler应该是被@Sharable注释，因为一个ChannelHandler可能属于多个ChannelPipeline。在使用@Sharable之前，最好确保当前ChannelHandler是线程安全。</p><h4 id="ChannelFuture"><a href="#ChannelFuture" class="headerlink" title="ChannelFuture"></a>ChannelFuture</h4><blockquote><p>Netty提供了ChannelFuture接口，其addListener()方法注册了一个ChannelFutureListener，以便在某个操作完成时（无论是否成功）得到通知。</p></blockquote><h4 id="Bootstrap"><a href="#Bootstrap" class="headerlink" title="Bootstrap"></a>Bootstrap</h4><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.ax1x.com/2020/02/07/1gyOJ0.png" alt="1gyOJ0.png"></p><ul><li>引导客户端 和 无连接协议<br>引导流程如下：<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.ax1x.com/2020/02/07/1g6GSf.png" alt="1g6GSf.png"></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">EchoClient</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">SSL</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;ssl&quot;</span>) != <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">HOST</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;host&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> Integer.parseInt(System.getProperty(<span class="string">&quot;port&quot;</span>, <span class="string">&quot;8023&quot;</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Configure SSL.git</span></span><br><span class="line">        <span class="keyword">final</span> SslContext sslCtx;</span><br><span class="line">        <span class="keyword">if</span> (SSL) &#123;</span><br><span class="line">            sslCtx = SslContextBuilder.forClient()</span><br><span class="line">                    .trustManager(InsecureTrustManagerFactory.INSTANCE).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sslCtx = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Configure the client.</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">group</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Bootstrap</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">            b.group(group)</span><br><span class="line">                    .channel(NioSocketChannel.class)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            <span class="type">ChannelPipeline</span> <span class="variable">p</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">                            <span class="keyword">if</span> (sslCtx != <span class="literal">null</span>) &#123;</span><br><span class="line">                                p.addLast(sslCtx.newHandler(ch.alloc(), HOST, PORT));</span><br><span class="line">                            &#125;</span><br><span class="line">                            p.addLast(</span><br><span class="line">                                    <span class="keyword">new</span> <span class="title class_">CustomSimpleChannelInboundHandler</span>())</span><br><span class="line">                            ;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 在connect方法调用后，Bootstrap类将会创建一个新的Channel</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> b.connect(HOST, PORT).sync();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Wait until the connection is closed.</span></span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// Shut down the event loop to terminate all threads.</span></span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>引导服务器</li></ul><p>引导流程如下：<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.ax1x.com/2020/02/07/1g6tOg.png" alt="1g6tOg.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">EchoServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">SSL</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;ssl&quot;</span>) != <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PORT</span> <span class="operator">=</span> Integer.parseInt(System.getProperty(<span class="string">&quot;port&quot;</span>, <span class="string">&quot;8007&quot;</span>));</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SECOND_HANDLER_NAME</span> <span class="operator">=</span> <span class="string">&quot;second&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// Configure SSL.</span></span><br><span class="line">        <span class="keyword">final</span> SslContext sslCtx;</span><br><span class="line">        <span class="keyword">if</span> (SSL) &#123;</span><br><span class="line">            <span class="type">SelfSignedCertificate</span> <span class="variable">ssc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SelfSignedCertificate</span>();</span><br><span class="line">            sslCtx = SslContextBuilder.forServer(ssc.certificate(), ssc.privateKey()).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sslCtx = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Configure the server.</span></span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">EventLoopGroup</span> <span class="variable">workerGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">EchoServerHandler</span> <span class="variable">serverHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EchoServerHandler</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ServerBootstrap</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">            b.group(bossGroup, workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel.class)</span><br><span class="line">                    .option(ChannelOption.SO_BACKLOG, <span class="number">100</span>)</span><br><span class="line">                    .handler(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">                    .childHandler(<span class="keyword">new</span> <span class="title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            <span class="type">ChannelPipeline</span> <span class="variable">p</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">                            <span class="keyword">if</span> (sslCtx != <span class="literal">null</span>) &#123;</span><br><span class="line">                            p.addLast(sslCtx.newHandler(ch.alloc()));</span><br><span class="line">                            p.addLast(serverHandler);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Start the server.</span></span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">f</span> <span class="operator">=</span> b.bind(PORT).sync();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Wait until the server socket is closed.</span></span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// Shut down all event loops to terminate all threads.</span></span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li><p>引导DatagramChannel<br>Netty提供了各种DatagramChannel的实现，它唯一的区别就是不能使用connect方法，只能调用bind方法。</p></li><li><p>如何优雅关闭客户端和服务端</p></li></ul><blockquote><p>我主要需要关闭我们创建EventLoopGroup，我们可以通过<code>shutdownGracefully</code>方法来优雅地关闭。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Future&lt;?&gt; shutdownGracefully(<span class="type">long</span> quietPeriod, <span class="type">long</span> timeout, TimeUnit unit) &#123;</span><br><span class="line">    <span class="keyword">for</span> (EventExecutor l: children) &#123;</span><br><span class="line">        l.shutdownGracefully(quietPeriod, timeout, unit);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> terminationFuture();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="重新认识字节"><a href="#重新认识字节" class="headerlink" title="重新认识字节"></a>重新认识字节</h3><blockquote><p>The byte is a unit of digital information that most commonly consists of eight bits. Historically, the byte was the number of bits used to encode a single character of text in a computer and for this reason it is the smallest addressable unit of memory in many computer architectures<br>记住：8 bit &#x3D; 1 byte</p></blockquote><p>为啥说重新认识了字节，因为自己在学习ByteBuf的时候犯了一些低级的错误（单元测试将呈现我的低级错误），反应出来自己的基础还是不够牢固。<br>下面这通过练习的例子，来认识一下Netty强大的字节容器：ByteBuff</p><blockquote><p>ByteBuff，实现原理有两个索引指针，一个用于读取（readerIndex），一个用于写入（writerIndex）。</p></blockquote><p>下面的例子详细说，不同ByteBuff的使用模式：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ByteBuffExample</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">HI_BYTE_BUFF</span> <span class="operator">=</span> <span class="string">&quot;Hi! ByteBuff.&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ByteBuf</span> <span class="variable">heapBuff</span> <span class="operator">=</span> Unpooled.copiedBuffer(HI_BYTE_BUFF, CharsetUtil.UTF_8);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Charset</span> <span class="variable">UTF_8</span> <span class="operator">=</span> CharsetUtil.UTF_8;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 堆缓冲区</span></span><br><span class="line">        System.out.println(<span class="string">&quot;==================heap buff==================&quot;</span>);</span><br><span class="line">        heapByteBuff();</span><br><span class="line">        System.out.println(<span class="string">&quot;==================direct buff==================&quot;</span>);</span><br><span class="line">        directByteBuff();</span><br><span class="line">        System.out.println(<span class="string">&quot;==================composite buff==================&quot;</span>);</span><br><span class="line">        compositeByteBuff();</span><br><span class="line">        System.out.println(<span class="string">&quot;==================read and write==================&quot;</span>);</span><br><span class="line">        readAndWrite();</span><br><span class="line">        System.out.println(<span class="string">&quot;==================ByteBufHolder==================&quot;</span>);</span><br><span class="line">        byteBuffHolder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存储在 JVM 堆空间中，这种模式被成为支撑数据（backing array）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">heapByteBuff</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (heapBuff.hasArray()) &#123;</span><br><span class="line">            <span class="type">byte</span>[] array = heapBuff.array();</span><br><span class="line">            <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> heapBuff.arrayOffset() + heapBuff.readerIndex();</span><br><span class="line">            <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> heapBuff.readableBytes();</span><br><span class="line">            <span class="type">byte</span>[] target = <span class="keyword">new</span> <span class="title class_">byte</span>[length];</span><br><span class="line">            System.arraycopy(array, offset, target, <span class="number">0</span>, length);</span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(target));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 直接缓冲区是另外一种ByteBuf模式。</span></span><br><span class="line"><span class="comment">     * 我们期望用于对象创建的内存分配永远都来自于堆中，</span></span><br><span class="line"><span class="comment">     * 但这并不是必须的——NIO在JDK1.4中引入的ByteBuffer类允许JVM实现通过本地调用来分配内存。</span></span><br><span class="line"><span class="comment">     * 这主要是为了避免在每次调用本地I/O操作之前（或者之后）</span></span><br><span class="line"><span class="comment">     * 将缓冲区的内容复制到一个中间缓冲区（或者从中间缓冲区把内容复制到缓冲区）。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 它的缺点主要：</span></span><br><span class="line"><span class="comment">     * 1. 分配和释放表昂贵</span></span><br><span class="line"><span class="comment">     * 2. 如果在处理预留代码的时候，可能不得不又复制一遍。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 建议：如果在知道数据将被作为数据来访问的时候，我们更加推荐使用 堆内存 。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">directByteBuff</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">directBuffer</span> <span class="operator">=</span> Unpooled.directBuffer().writeBytes(heapBuff);</span><br><span class="line">        <span class="comment">// 检查buf是否有数组，如果不是，则说明一个直接堆缓冲区</span></span><br><span class="line">        <span class="keyword">if</span> (!directBuffer.hasArray()) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">readerIndex</span> <span class="operator">=</span> directBuffer.readerIndex();</span><br><span class="line">            <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> directBuffer.readableBytes();</span><br><span class="line">            <span class="type">byte</span>[] array = <span class="keyword">new</span> <span class="title class_">byte</span>[length];</span><br><span class="line">            directBuffer.getBytes(readerIndex, array);</span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(array));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 复合缓冲区，它提供一种聚合模式给我们使用。例如我需要组合一个协议，</span></span><br><span class="line"><span class="comment">     * 我们需要一部分装配头部信息，一部分装配主体信息。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">compositeByteBuff</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CompositeByteBuf</span> <span class="variable">compositeByteBuf</span> <span class="operator">=</span> Unpooled.compositeBuffer();</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">headBuf</span> <span class="operator">=</span> Unpooled.copiedBuffer(<span class="string">&quot;Hi! &quot;</span>, CharsetUtil.UTF_8);</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">bodyBuf</span> <span class="operator">=</span> Unpooled.copiedBuffer(<span class="string">&quot;ByteBuff.&quot;</span>, CharsetUtil.UTF_8);</span><br><span class="line">        compositeByteBuf.addComponents(headBuf, bodyBuf);</span><br><span class="line">        System.out.println(<span class="string">&quot;compositeByteBuf.removeComponent(0) before:&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (ByteBuf byteBuf : compositeByteBuf) &#123;</span><br><span class="line">            System.out.println(byteBuf.toString(CharsetUtil.UTF_8));</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;compositeByteBuf.removeComponent(0) after:&quot;</span>);</span><br><span class="line">        compositeByteBuf.removeComponent(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (ByteBuf byteBuf : compositeByteBuf) &#123;</span><br><span class="line">            System.out.println(byteBuf.toString(CharsetUtil.UTF_8));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主要是一些字节操作API的使用。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">readAndWrite</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">byteBuf</span> <span class="operator">=</span> Unpooled.copiedBuffer(HI_BYTE_BUFF, CharsetUtil.UTF_8);</span><br><span class="line">        System.out.println(byteBuf.toString(CharsetUtil.UTF_8));</span><br><span class="line">        <span class="comment">// slice，分片，但是不会修改索引信息</span></span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">slice</span> <span class="operator">=</span> byteBuf.slice(<span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">        <span class="comment">// 拷贝操作，不影响原对象</span></span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">copy</span> <span class="operator">=</span> byteBuf.copy(<span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">        <span class="keyword">assert</span> !ByteBufUtil.equals(slice, copy);</span><br><span class="line">        System.out.println(slice.toString(CharsetUtil.UTF_8));</span><br><span class="line">        byteBuf.setByte(<span class="number">0</span>, ((<span class="type">byte</span>) <span class="string">&#x27;J&#x27;</span>));</span><br><span class="line">        copy.setByte(<span class="number">0</span>, ((<span class="type">byte</span>) <span class="string">&#x27;W&#x27;</span>));</span><br><span class="line">        <span class="keyword">assert</span> byteBuf.getByte(<span class="number">0</span>) == slice.getByte(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">assert</span> copy.getByte(<span class="number">0</span>) != byteBuf.getByte(<span class="number">0</span>);</span><br><span class="line">        System.out.println(((<span class="type">char</span>) byteBuf.getByte(<span class="number">0</span>)));</span><br><span class="line">        <span class="type">int</span> <span class="variable">readerIndex</span> <span class="operator">=</span> byteBuf.readerIndex();</span><br><span class="line">        <span class="type">int</span> <span class="variable">writerIndex</span> <span class="operator">=</span> byteBuf.writerIndex();</span><br><span class="line">        byteBuf.setByte(<span class="number">1</span>, ((<span class="type">byte</span>) <span class="string">&#x27;B&#x27;</span>));</span><br><span class="line">        System.out.println(((<span class="type">char</span>) byteBuf.getByte(<span class="number">1</span>)));</span><br><span class="line">        <span class="type">assert</span> <span class="variable">readerIndex</span> <span class="operator">=</span>= byteBuf.readerIndex();</span><br><span class="line">        <span class="type">assert</span> <span class="variable">writerIndex</span> <span class="operator">=</span>= byteBuf.writerIndex();</span><br><span class="line">        <span class="comment">// 写一个字节，将会影响writerIndex索引。</span></span><br><span class="line">        byteBuf.writeByte(((<span class="type">byte</span>) <span class="string">&#x27;?&#x27;</span>));</span><br><span class="line">        <span class="type">assert</span> <span class="variable">readerIndex</span> <span class="operator">=</span>= byteBuf.readerIndex();</span><br><span class="line">        <span class="keyword">assert</span> writerIndex != byteBuf.writerIndex();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">byteBuffHolder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ByteBufHolder</span> <span class="variable">byteBufHolder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultByteBufHolder</span>(Unpooled.copiedBuffer(HI_BYTE_BUFF, UTF_8));</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">content</span> <span class="operator">=</span> byteBufHolder.copy().content();</span><br><span class="line">        content.setByte(<span class="number">0</span>, ((<span class="type">byte</span>) <span class="string">&#x27;W&#x27;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;source: &quot;</span> + ((<span class="type">char</span>) heapBuff.getByte(<span class="number">0</span>)));</span><br><span class="line">        System.out.println(<span class="string">&quot;new: &quot;</span> + ((<span class="type">char</span>) content.getByte(<span class="number">0</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="解码器和编码器"><a href="#解码器和编码器" class="headerlink" title="解码器和编码器"></a>解码器和编码器</h3><h4 id="解码器"><a href="#解码器" class="headerlink" title="解码器"></a>解码器</h4><p>总体来说，我们有两种需求：</p><ul><li>字节解码成消息，常用抽象类：ByteToMessageDecoder extends ChannelInboundHandlerAdapter</li><li>消息A解码成消息B，常用抽象类：MessageToMessageDecoder extends ChannelInboundHandlerAdapter<br>它们都是继承 ChannelInboundHandlerAdapter，又是熟悉的味道，这个又是得益Netty统一的设计。<br>流程图如下：<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.ax1x.com/2020/02/07/1gv0E9.png" alt="1gv0E9.png"></li></ul><h4 id="编码器"><a href="#编码器" class="headerlink" title="编码器"></a>编码器</h4><p>总体来说，我们有两种需求：</p><ul><li>消息编码成消息，常用抽象类：MessageToByteEncoder extends ChannelOutboundHandlerAdapter</li><li>消息B编码成消息A，常用抽象类：MessageToMessageEncoder extends ChannelOutboundHandlerAdapter<br>它们都是继承了ChannelOutboundHandlerAdapter。<br>流程图如下：<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.ax1x.com/2020/02/07/1gzNTJ.png" alt="1gzNTJ.png"></li></ul><h4 id="抽象的编解码类"><a href="#抽象的编解码类" class="headerlink" title="抽象的编解码类"></a>抽象的编解码类</h4><p>很多时候，编解码是一对，我们就想着为啥不能直接设置成一个类？Netty给我们，预设Codec。</p><ul><li>字节编解码成消息，ByteToMessageCodec extend ChannelDuplexHandler</li><li>消息编解码成消息，MessageToMessageCodec extend ChannelDuplexHandler<br>ChannelDuplexHandler extends ChannelInboundHandlerAdapter implements ChannelOutboundHandler</li></ul><h4 id="HttpObjectAggregator-源码分析"><a href="#HttpObjectAggregator-源码分析" class="headerlink" title="HttpObjectAggregator 源码分析"></a>HttpObjectAggregator 源码分析</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HttpObjectAggregator</span><br><span class="line">        <span class="keyword">extends</span> <span class="title class_">MessageAggregator</span>&lt;HttpObject, HttpMessage, HttpContent, FullHttpMessage&gt;</span><br></pre></td></tr></table></figure><p>核心逻辑其实是在 MessageAggregator 中 decode 方法中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx, I msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">assert</span> aggregating;</span><br><span class="line">        <span class="comment">// HttpObjectAggregator.isStartMessage:</span></span><br><span class="line">        <span class="comment">// return msg instanceof HttpMessage;</span></span><br><span class="line">        <span class="keyword">if</span> (isStartMessage(msg)) &#123;</span><br><span class="line">            handlingOversizedMessage = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (currentMessage != <span class="literal">null</span>) &#123;</span><br><span class="line">                currentMessage.release();</span><br><span class="line">                currentMessage = <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MessageAggregationException</span>();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="type">S</span> <span class="variable">m</span> <span class="operator">=</span> (S) msg;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Send the continue response if necessary (e.g. &#x27;Expect: 100-continue&#x27; header)</span></span><br><span class="line">            <span class="comment">// Check before content length. Failing an expectation may result in a different response being sent.</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">continueResponse</span> <span class="operator">=</span> newContinueResponse(m, maxContentLength, ctx.pipeline());</span><br><span class="line">            <span class="keyword">if</span> (continueResponse != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Cache the write listener for reuse.</span></span><br><span class="line">                <span class="comment">// 缓存起来监听器方便重用，监听器作用：如果调用不成功，则调用fireExceptionCaught方法，抛出异常</span></span><br><span class="line">                <span class="type">ChannelFutureListener</span> <span class="variable">listener</span> <span class="operator">=</span> continueResponseWriteListener;</span><br><span class="line">                <span class="keyword">if</span> (listener == <span class="literal">null</span>) &#123;</span><br><span class="line">                    continueResponseWriteListener = listener = <span class="keyword">new</span> <span class="title class_">ChannelFutureListener</span>() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                            <span class="keyword">if</span> (!future.isSuccess()) &#123;</span><br><span class="line">                                ctx.fireExceptionCaught(future.cause());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Make sure to call this before writing, otherwise reference counts may be invalid.</span></span><br><span class="line">                <span class="type">boolean</span> <span class="variable">closeAfterWrite</span> <span class="operator">=</span> closeAfterContinueResponse(continueResponse);</span><br><span class="line">                handlingOversizedMessage = ignoreContentAfterContinueResponse(continueResponse);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> ctx.writeAndFlush(continueResponse).addListener(listener);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (closeAfterWrite) &#123;</span><br><span class="line">                    future.addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (handlingOversizedMessage) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isContentLengthInvalid(m, maxContentLength)) &#123;</span><br><span class="line">                <span class="comment">// if content length is set, preemptively close if it&#x27;s too large</span></span><br><span class="line">                invokeHandleOversizedMessage(ctx, m);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (m <span class="keyword">instanceof</span> DecoderResultProvider &amp;&amp; !((DecoderResultProvider) m).decoderResult().isSuccess()) &#123;</span><br><span class="line">                O aggregated;</span><br><span class="line">                <span class="keyword">if</span> (m <span class="keyword">instanceof</span> ByteBufHolder) &#123;</span><br><span class="line">                    <span class="comment">// retain方法：将引用增加+1（Netty中，如果引用值为0，则会被回收），以防止被回收</span></span><br><span class="line">                    <span class="comment">// 开始聚合操作由子类实现对应的操作</span></span><br><span class="line">                    aggregated = beginAggregation(m, ((ByteBufHolder) m).content().retain());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    aggregated = beginAggregation(m, EMPTY_BUFFER);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 完成聚合操作，finishAggregation0 中调用了 finishAggregation,其中finishAggregation由子类实现。</span></span><br><span class="line">                <span class="comment">// HttpObjectAggregator中实现了，增加了rfc2616 14.13 Content-Length 判断，如果没有响应体头部那样设置 &#x27;Content-Length&#x27;，则根据 aggregated.content().readableBytes() 设置一个值</span></span><br><span class="line">                finishAggregation0(aggregated);</span><br><span class="line">                out.add(aggregated);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// A streamed message - initialize the cumulative buffer, and wait for incoming chunks.</span></span><br><span class="line">            <span class="type">CompositeByteBuf</span> <span class="variable">content</span> <span class="operator">=</span> ctx.alloc().compositeBuffer(maxCumulationBufferComponents);</span><br><span class="line">            <span class="keyword">if</span> (m <span class="keyword">instanceof</span> ByteBufHolder) &#123;</span><br><span class="line">                appendPartialContent(content, ((ByteBufHolder) m).content());</span><br><span class="line">            &#125;</span><br><span class="line">            currentMessage = beginAggregation(m, content);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isContentMessage(msg)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (currentMessage == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// it is possible that a TooLongFrameException was already thrown but we can still discard data</span></span><br><span class="line">                <span class="comment">// until the begging of the next request/response.</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Merge the received chunk into the content of the current message.</span></span><br><span class="line">            <span class="type">CompositeByteBuf</span> <span class="variable">content</span> <span class="operator">=</span> (CompositeByteBuf) currentMessage.content();</span><br><span class="line"></span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">C</span> <span class="variable">m</span> <span class="operator">=</span> (C) msg;</span><br><span class="line">            <span class="comment">// Handle oversized message.</span></span><br><span class="line">            <span class="keyword">if</span> (content.readableBytes() &gt; maxContentLength - m.content().readableBytes()) &#123;</span><br><span class="line">                <span class="comment">// By convention, full message type extends first message type.</span></span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                <span class="type">S</span> <span class="variable">s</span> <span class="operator">=</span> (S) currentMessage;</span><br><span class="line">                invokeHandleOversizedMessage(ctx, s);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Append the content of the chunk.</span></span><br><span class="line">            appendPartialContent(content, m.content());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Give the subtypes a chance to merge additional information such as trailing headers.</span></span><br><span class="line">            aggregate(currentMessage, m);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> last;</span><br><span class="line">            <span class="comment">// 主要判断 是否为 最后的消息了，如果是最后的消息，将进行添加输出列表out中</span></span><br><span class="line">            <span class="keyword">if</span> (m <span class="keyword">instanceof</span> DecoderResultProvider) &#123;</span><br><span class="line">                <span class="type">DecoderResult</span> <span class="variable">decoderResult</span> <span class="operator">=</span> ((DecoderResultProvider) m).decoderResult();</span><br><span class="line">                <span class="keyword">if</span> (!decoderResult.isSuccess()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (currentMessage <span class="keyword">instanceof</span> DecoderResultProvider) &#123;</span><br><span class="line">                        ((DecoderResultProvider) currentMessage).setDecoderResult(</span><br><span class="line">                                DecoderResult.failure(decoderResult.cause()));</span><br><span class="line">                    &#125;</span><br><span class="line">                    last = <span class="literal">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    last = isLastContentMessage(m);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                last = isLastContentMessage(m);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (last) &#123;</span><br><span class="line">                finishAggregation0(currentMessage);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// All done</span></span><br><span class="line">                out.add(currentMessage);</span><br><span class="line">                currentMessage = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MessageAggregationException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="不可被忽略的单元测试"><a href="#不可被忽略的单元测试" class="headerlink" title="不可被忽略的单元测试"></a>不可被忽略的单元测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AbsIntegerEncoder 测试类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jaryoung.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-02-02 21:26</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AbsIntegerEncoder</span> <span class="keyword">extends</span> <span class="title class_">MessageToMessageEncoder</span>&lt;ByteBuf&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">encode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="comment">// 这里就是我犯下的低级错误，当时没有想明白，为啥是4呢？</span></span><br><span class="line">            <span class="comment">// 如果我们知道int是占4个字节，就很容易理解了。</span></span><br><span class="line">            <span class="comment">// 也是从这里，让我反思。</span></span><br><span class="line">        <span class="keyword">while</span> (msg.readableBytes() &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> Math.abs(msg.readInt());</span><br><span class="line">            out.add(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AbsIntegerEncoderTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testAbsIntegerEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">byteBuf</span> <span class="operator">=</span> Unpooled.buffer();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            byteBuf.writeInt(i * -<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">EmbeddedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EmbeddedChannel</span>(<span class="keyword">new</span> <span class="title class_">AbsIntegerEncoder</span>());</span><br><span class="line">        Assert.assertTrue(channel.writeOutbound(byteBuf));</span><br><span class="line">        Assert.assertTrue(channel.finish());</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            Assert.assertEquals(i, ((<span class="type">int</span>) channel.readOutbound()));</span><br><span class="line">        &#125;</span><br><span class="line">        Assert.assertNull(channel.readOutbound());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义待测试待 解码器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jaryoung.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-02-02 20:56</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FixedLengthFrameDecoder</span> <span class="keyword">extends</span> <span class="title class_">ByteToMessageDecoder</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> frameLength;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">FixedLengthFrameDecoder</span><span class="params">(<span class="type">int</span> frameLength)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (frameLength &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;frameLength must be a positive integer: &quot;</span> + frameLength);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.frameLength = frameLength;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">while</span> (in.readableBytes() &gt;= frameLength) &#123;</span><br><span class="line">            <span class="type">ByteBuf</span> <span class="variable">buf</span> <span class="operator">=</span> in.readBytes(frameLength);</span><br><span class="line">            out.add(buf);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FrameChunkDecoderTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testFrameChunkDecoderException</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">byteBuf</span> <span class="operator">=</span> Unpooled.buffer();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            byteBuf.writeByte(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">input</span> <span class="operator">=</span> byteBuf.duplicate();</span><br><span class="line">        <span class="type">EmbeddedChannel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EmbeddedChannel</span>(<span class="keyword">new</span> <span class="title class_">FrameChunkDecoder</span>(<span class="number">3</span>));</span><br><span class="line">        Assert.assertTrue(channel.writeInbound(input.readBytes(<span class="number">2</span>)));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            channel.writeInbound(input.readBytes(<span class="number">4</span>));</span><br><span class="line">            Assert.fail();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Assert.assertTrue(e <span class="keyword">instanceof</span> TooLongFrameException);</span><br><span class="line">        &#125;</span><br><span class="line">        Assert.assertTrue(channel.writeInbound(input.readBytes(<span class="number">3</span>)));</span><br><span class="line"></span><br><span class="line">        Assert.assertTrue(channel.finish());</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteBuf</span> <span class="variable">read</span> <span class="operator">=</span> channel.readInbound();</span><br><span class="line">        Assert.assertEquals(byteBuf.readSlice(<span class="number">2</span>), read);</span><br><span class="line">        read.release();</span><br><span class="line"></span><br><span class="line">        read = channel.readInbound();</span><br><span class="line">        Assert.assertEquals(byteBuf.skipBytes(<span class="number">4</span>).readSlice(<span class="number">3</span>), read);</span><br><span class="line">        read.release();</span><br><span class="line"></span><br><span class="line">        Assert.assertNull(channel.readInbound());</span><br><span class="line">        byteBuf.release();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="网络协议"><a href="#网络协议" class="headerlink" title="网络协议"></a>网络协议</h2><h3 id="使用WebSocket"><a href="#使用WebSocket" class="headerlink" title="使用WebSocket"></a>使用WebSocket</h3><blockquote><p>WebSocket ，WebSocket协议是完全重新设计的协议，旨在为Web上的双向数据传输问题提供一个切实可行的解决方案，使得客户端和服务器之间可以在任意时刻传输消息，因此，这也就要求它们异步地处理消息回执。</p></blockquote><p>使用WebSocket实现一个简单的聊天室，总体架构图如下：<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.ax1x.com/2020/02/07/12ZsXj.png" alt="12ZsXj.png"><br>服务器的流程图如下：<br><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.ax1x.com/2020/02/07/12Z6ns.png" alt="12Z6ns.png"></p><p>大概代码结构如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">├─main</span><br><span class="line">    ├─java</span><br><span class="line">        ├─handler</span><br><span class="line">            ├─HttpRequestHandler</span><br><span class="line">            ├─TextWebSocketFrameHandler</span><br><span class="line">        ├─initializer</span><br><span class="line">            ├─ChatServerInitializer</span><br><span class="line">            ├─SecureChatServerInitializer</span><br><span class="line">        ├─server</span><br><span class="line">            ├─ChatServer</span><br><span class="line">            ├─SecureChatServer</span><br><span class="line">    ├─resource</span><br><span class="line">    ├─index.html</span><br><span class="line">├─test</span><br><span class="line">├─pom.xml</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.netty.channel.*;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.*;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.ssl.SslHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.stream.ChunkedNioFile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.RandomAccessFile;</span><br><span class="line"><span class="keyword">import</span> java.net.URISyntaxException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * HttpRequestHandler</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jaryoung.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-02-05 15:25</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpRequestHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;FullHttpRequest&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String wsUri;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> File INDEX;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">location</span> <span class="operator">=</span> HttpRequestHandler.class.getProtectionDomain().getCodeSource().getLocation();</span><br><span class="line">        String path;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            path = location.toURI() + <span class="string">&quot;index.html&quot;</span>;</span><br><span class="line">            path = !path.contains(<span class="string">&quot;file:&quot;</span>) ? path : path.substring(<span class="number">5</span>);</span><br><span class="line">            INDEX = <span class="keyword">new</span> <span class="title class_">File</span>(path);</span><br><span class="line">            <span class="keyword">if</span> (!INDEX.exists()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;path :&quot;</span> + path + <span class="string">&quot; not found&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (URISyntaxException | FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HttpRequestHandler</span><span class="params">(String wsUri)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.wsUri = wsUri;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, FullHttpRequest request)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (wsUri.equalsIgnoreCase(request.uri())) &#123;</span><br><span class="line">            ctx.fireChannelRead(request.retain());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (HttpUtil.is100ContinueExpected(request)) &#123;</span><br><span class="line">                send100Continue(ctx);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">RandomAccessFile</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomAccessFile</span>(INDEX, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">            <span class="type">HttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultHttpResponse</span>(request.protocolVersion(), HttpResponseStatus.OK);</span><br><span class="line">            response.headers().set(HttpHeaderNames.CONTENT_TYPE, <span class="string">&quot;text/html; charset=UTF-8&quot;</span>);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">keepAlive</span> <span class="operator">=</span> HttpUtil.isKeepAlive(request);</span><br><span class="line">            <span class="keyword">if</span> (keepAlive) &#123;</span><br><span class="line">                response.headers().set(HttpHeaderNames.CONTENT_LENGTH, file.length());</span><br><span class="line">                response.headers().set(HttpHeaderNames.CONNECTION, HttpHeaderValues.KEEP_ALIVE);</span><br><span class="line">            &#125;</span><br><span class="line">            ctx.write(response);</span><br><span class="line">            <span class="keyword">if</span> (ctx.pipeline().get(SslHandler.class) == <span class="literal">null</span>) &#123;</span><br><span class="line">                ctx.write(<span class="keyword">new</span> <span class="title class_">DefaultFileRegion</span>(file.getChannel(), <span class="number">0</span>, file.length()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ctx.write(<span class="keyword">new</span> <span class="title class_">ChunkedNioFile</span>(file.getChannel()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> ctx.writeAndFlush(LastHttpContent.EMPTY_LAST_CONTENT);</span><br><span class="line">            <span class="keyword">if</span> (!keepAlive) &#123;</span><br><span class="line">                future.addListener(ChannelFutureListener.CLOSE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">send100Continue</span><span class="params">(ChannelHandlerContext ctx)</span> &#123;</span><br><span class="line">        <span class="type">FullHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1, HttpResponseStatus.CONTINUE);</span><br><span class="line">        ctx.writeAndFlush(response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelHandlerContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.group.ChannelGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.websocketx.TextWebSocketFrame;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TextWebSocketFrameHandler</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jaryoung.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-02-05 15:58</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TextWebSocketFrameHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleChannelInboundHandler</span>&lt;TextWebSocketFrame&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChannelGroup group;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TextWebSocketFrameHandler</span><span class="params">(ChannelGroup group)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.group = group;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (evt <span class="keyword">instanceof</span> WebSocketServerProtocolHandler.HandshakeComplete) &#123;</span><br><span class="line">            ctx.pipeline().remove(HttpRequestHandler.class);</span><br><span class="line">            group.writeAndFlush(<span class="keyword">new</span> <span class="title class_">TextWebSocketFrame</span>(<span class="string">&quot;Client &quot;</span> + ctx.channel() + <span class="string">&quot; joined&quot;</span>));</span><br><span class="line">            group.add(ctx.channel());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>.userEventTriggered(ctx, evt);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">channelRead0</span><span class="params">(ChannelHandlerContext ctx, TextWebSocketFrame msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        group.writeAndFlush(msg.retain());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelPipeline;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.group.ChannelGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.example.ws.handler.HttpRequestHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.example.ws.handler.TextWebSocketFrameHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpObjectAggregator;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.HttpServerCodec;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.logging.LogLevel;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.logging.LoggingHandler;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.stream.ChunkedWriteHandler;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ChatServerInitializer</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jaryoung.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-02-05 16:08</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatServerInitializer</span> <span class="keyword">extends</span> <span class="title class_">ChannelInitializer</span>&lt;Channel&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChannelGroup group;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChatServerInitializer</span><span class="params">(ChannelGroup group)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.group = group;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(Channel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ChannelPipeline</span> <span class="variable">pipeline</span> <span class="operator">=</span> ch.pipeline();</span><br><span class="line">        pipeline.addLast(<span class="keyword">new</span> <span class="title class_">HttpServerCodec</span>())</span><br><span class="line">                .addLast(<span class="keyword">new</span> <span class="title class_">ChunkedWriteHandler</span>())</span><br><span class="line">                .addLast(<span class="keyword">new</span> <span class="title class_">HttpObjectAggregator</span>(<span class="number">64</span> * <span class="number">1024</span>))</span><br><span class="line">                .addLast(<span class="keyword">new</span> <span class="title class_">HttpRequestHandler</span>(<span class="string">&quot;/ws&quot;</span>))</span><br><span class="line">                .addLast(<span class="keyword">new</span> <span class="title class_">WebSocketServerProtocolHandler</span>(<span class="string">&quot;/ws&quot;</span>))</span><br><span class="line">                .addLast(<span class="keyword">new</span> <span class="title class_">TextWebSocketFrameHandler</span>(group))</span><br><span class="line">                .addLast(<span class="keyword">new</span> <span class="title class_">LoggingHandler</span>(LogLevel.INFO))</span><br><span class="line">        ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.group.ChannelGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.ssl.SslContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.ssl.SslHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLEngine;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SecureChatServerInitializer</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jaryoung.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-02-05 21:38</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecureChatServerInitializer</span> <span class="keyword">extends</span> <span class="title class_">ChatServerInitializer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SslContext sslContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecureChatServerInitializer</span><span class="params">(ChannelGroup channelGroup, SslContext sslContext)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(channelGroup);</span><br><span class="line">        <span class="built_in">this</span>.sslContext = sslContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initChannel</span><span class="params">(Channel ch)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">super</span>.initChannel(ch);</span><br><span class="line">        <span class="type">SSLEngine</span> <span class="variable">engine</span> <span class="operator">=</span> sslContext.newHandler(ch.alloc()).engine();</span><br><span class="line">        engine.setUseClientMode(<span class="literal">false</span>);</span><br><span class="line">        ch.pipeline().addFirst(<span class="keyword">new</span> <span class="title class_">SslHandler</span>(engine));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.netty.bootstrap.ServerBootstrap;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelFuture;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.EventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.group.ChannelGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.group.DefaultChannelGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;</span><br><span class="line"><span class="keyword">import</span> io.netty.example.ws.initializer.ChatServerInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.util.concurrent.ImmediateEventExecutor;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ChatServer</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jaryoung.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-02-05 16:29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ChannelGroup</span> <span class="variable">channelGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultChannelGroup</span>(ImmediateEventExecutor.INSTANCE);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">EventLoopGroup</span> <span class="variable">bossGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">EventLoopGroup</span> <span class="variable">workGroup</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NioEventLoopGroup</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">private</span> Channel channel;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">SERVER_PORT</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;port&quot;</span>, <span class="string">&quot;9999&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(ChatServer.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> ChannelFuture <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> Integer.parseInt(SERVER_PORT);</span><br><span class="line">        <span class="type">ServerBootstrap</span> <span class="variable">serverBootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerBootstrap</span>();</span><br><span class="line">        serverBootstrap.group(bossGroup, workGroup)</span><br><span class="line">                .channel(NioServerSocketChannel.class)</span><br><span class="line">                .childHandler(createInitializer(channelGroup));</span><br><span class="line">        <span class="type">ChannelFuture</span> <span class="variable">future</span> <span class="operator">=</span> serverBootstrap.bind(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(port));</span><br><span class="line">        future.syncUninterruptibly();</span><br><span class="line">        channel = future.channel();</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="built_in">this</span>::destroy));</span><br><span class="line">        Objects.requireNonNull(future).channel().closeFuture().syncUninterruptibly();</span><br><span class="line">        <span class="keyword">if</span> (future.isSuccess()) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;Chat Server start, port: &#123;&#125;&quot;</span>, port);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;Chat Server start failed, port: &#123;&#125;&quot;</span>, port);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> future;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> ChannelInitializer&lt;Channel&gt; <span class="title function_">createInitializer</span><span class="params">(ChannelGroup channelGroup)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ChatServerInitializer</span>(channelGroup);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (channel != <span class="literal">null</span>) &#123;</span><br><span class="line">            channel.close();</span><br><span class="line">        &#125;</span><br><span class="line">        channelGroup.close();</span><br><span class="line">        bossGroup.shutdownGracefully();</span><br><span class="line">        workGroup.shutdownGracefully();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ChatServer</span>().start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.netty.channel.Channel;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.ChannelInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.channel.group.ChannelGroup;</span><br><span class="line"><span class="keyword">import</span> io.netty.example.ws.initializer.SecureChatServerInitializer;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.ssl.SslContext;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.ssl.SslContextBuilder;</span><br><span class="line"><span class="keyword">import</span> io.netty.handler.ssl.util.SelfSignedCertificate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLException;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.CertificateException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SecureChatServer</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jaryoung.com</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020-02-05 21:35</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecureChatServer</span> <span class="keyword">extends</span> <span class="title class_">ChatServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SslContext sslContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecureChatServer</span><span class="params">(SslContext sslContext)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sslContext = sslContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> ChannelInitializer&lt;Channel&gt; <span class="title function_">createInitializer</span><span class="params">(ChannelGroup channelGroup)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SecureChatServerInitializer</span>(channelGroup, sslContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">SelfSignedCertificate</span> <span class="variable">certificate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SelfSignedCertificate</span>();</span><br><span class="line">            <span class="type">SslContext</span> <span class="variable">sslContext</span> <span class="operator">=</span> SslContextBuilder.forServer(certificate.certificate(), certificate.privateKey()).build();</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">SecureChatServer</span>(sslContext).start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SSLException | CertificateException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="最后聊聊"><a href="#最后聊聊" class="headerlink" title="最后聊聊"></a>最后聊聊</h2><p>连续差不多两周的学习，通过看书+练习的操作，让自己能够将书上的知识，真的运用起来，并且进一步加深理解。<br>刻意练习真的太重要，如果光看不练，就是纸上谈兵。</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Jerry Wu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://jaryoung.com/2020/02/07/Netty-in-Action-After-Reading/">https://jaryoung.com/2020/02/07/Netty-in-Action-After-Reading/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://jaryoung.com" target="_blank">程序猿清丰</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/Netty/">Netty</a></div><div class="post_share"><div class="social-share" data-image="https://s2.ax1x.com/2020/02/07/12Z6ns.png" data-sites="wechat,weibo,qq,facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="ads-wrap"><ins class="adsbygoogle" style="display:block;text-align:center" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-4246138471118676" data-ad-slot="8104198642"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/03/08/Hystrix-How-it-Works/"><img class="prev-cover" src="https://s2.ax1x.com/2020/03/08/3zdwSU.png" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Hystrix 是如何工作？（翻译）</div></div></a></div><div class="next-post pull-right"><a href="/2020/01/04/Google-Elite-Security-Team-Project-Zero/"><img class="next-cover" src="https://images-cn.ssl-images-amazon.cn/images/I/41ZLiVMsGkL._SX343_BO1,204,203,200_.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Google's Elite Security Team, Project Zero</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2019/04/03/Java%E7%9A%84%E5%8C%85%E8%A3%85%E7%B1%BB%E5%9E%8B/" title="Java的包装类型"><img class="cover" src="https://cdn-clekk.nitrocdn.com/tkvYXMZryjYrSVhxKeFTeXElceKUYHeV/assets/static/optimized/rev-dc2ebe9/wp-content/uploads/2020/11/what-is-java-image.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-04-03</div><div class="title">Java的包装类型</div></div></a></div><div><a href="/2019/08/25/String-of-Java/" title="String of Java"><img class="cover" src="https://cdn-clekk.nitrocdn.com/tkvYXMZryjYrSVhxKeFTeXElceKUYHeV/assets/static/optimized/rev-dc2ebe9/wp-content/uploads/2020/11/what-is-java-image.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-08-25</div><div class="title">String of Java</div></div></a></div><div><a href="/2021/08/01/%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86maven/" title="重新认识maven"><img class="cover" src="https://tva1.sinaimg.cn/large/008i3skNly1gt1o34mj37j61gm0kqwg702.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-01</div><div class="title">重新认识maven</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/images/icons/icon-128x128.png" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">Jerry Wu</div><div class="author-info__description">Stay Hungry, Stay Foolish.</div></div><div class="card-info-data is-center"><div class="card-info-data-item"><a href="/archives/"><div class="headline">文章</div><div class="length-num">13</div></a></div><div class="card-info-data-item"><a href="/tags/"><div class="headline">标签</div><div class="length-num">19</div></a></div><div class="card-info-data-item"><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://zhihu.com/people/hy1839"><i class="fab fa-zhihu"></i><span>关注我</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://space.bilibili.com/74055039" target="_blank" title="Bilibili"><i class="iconfont icon-bilibili-line"></i></a><a class="social-icon" href="mailto:huige3344ai@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="Rss"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">如有任何疑问，可以添加我微信：wusonghui1839</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E7%BC%96%E6%88%91%E6%83%B3%E8%AF%B4"><span class="toc-number">1.</span> <span class="toc-text">开编我想说</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%85%E8%AF%BB%E5%89%8D%E7%9A%84%E9%A2%84%E4%B9%A0%EF%BC%8C%E5%A4%A7%E6%9C%89%E8%A3%A8%E7%9B%8A"><span class="toc-number">2.</span> <span class="toc-text">阅读前的预习，大有裨益</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">3.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%86%85%E5%AE%B9"><span class="toc-number">4.</span> <span class="toc-text">核心内容</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6"><span class="toc-number">4.1.</span> <span class="toc-text">核心组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Channel"><span class="toc-number">4.1.1.</span> <span class="toc-text">Channel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EventLoop"><span class="toc-number">4.1.2.</span> <span class="toc-text">EventLoop</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ChannelPipeline"><span class="toc-number">4.1.3.</span> <span class="toc-text">ChannelPipeline</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ChannelHandler"><span class="toc-number">4.1.4.</span> <span class="toc-text">ChannelHandler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ChannelHandlerContext"><span class="toc-number">4.1.5.</span> <span class="toc-text">ChannelHandlerContext</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ChannelFuture"><span class="toc-number">4.1.6.</span> <span class="toc-text">ChannelFuture</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Bootstrap"><span class="toc-number">4.1.7.</span> <span class="toc-text">Bootstrap</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86%E5%AD%97%E8%8A%82"><span class="toc-number">4.2.</span> <span class="toc-text">重新认识字节</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E7%A0%81%E5%99%A8%E5%92%8C%E7%BC%96%E7%A0%81%E5%99%A8"><span class="toc-number">4.3.</span> <span class="toc-text">解码器和编码器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E7%A0%81%E5%99%A8"><span class="toc-number">4.3.1.</span> <span class="toc-text">解码器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%96%E7%A0%81%E5%99%A8"><span class="toc-number">4.3.2.</span> <span class="toc-text">编码器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E7%9A%84%E7%BC%96%E8%A7%A3%E7%A0%81%E7%B1%BB"><span class="toc-number">4.3.3.</span> <span class="toc-text">抽象的编解码类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HttpObjectAggregator-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">4.3.4.</span> <span class="toc-text">HttpObjectAggregator 源码分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%8F%AF%E8%A2%AB%E5%BF%BD%E7%95%A5%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">4.4.</span> <span class="toc-text">不可被忽略的单元测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE"><span class="toc-number">5.</span> <span class="toc-text">网络协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8WebSocket"><span class="toc-number">5.1.</span> <span class="toc-text">使用WebSocket</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E5%90%8E%E8%81%8A%E8%81%8A"><span class="toc-number">6.</span> <span class="toc-text">最后聊聊</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/02/04/gulp-optimization-hexo-statict-resources/" title="利用Gulp优化Hexo静态资源"><img src="https://tva1.sinaimg.cn/large/008i3skNly1gz1ni3xnlbj31320u0ac9.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="利用Gulp优化Hexo静态资源"></a><div class="content"><a class="title" href="/2022/02/04/gulp-optimization-hexo-statict-resources/" title="利用Gulp优化Hexo静态资源">利用Gulp优化Hexo静态资源</a><time datetime="2022-02-04T10:24:00.000Z" title="发表于 2022-02-04 18:24:00">2022-02-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/02/03/Add-PWA-to-hexo-in-fluid-theme/" title="优化打开博客速度，给您的Hexo添加上PWA吧"><img src="https://tva1.sinaimg.cn/large/008i3skNly1gz0ndkga8rj31ms0u076k.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="优化打开博客速度，给您的Hexo添加上PWA吧"></a><div class="content"><a class="title" href="/2022/02/03/Add-PWA-to-hexo-in-fluid-theme/" title="优化打开博客速度，给您的Hexo添加上PWA吧">优化打开博客速度，给您的Hexo添加上PWA吧</a><time datetime="2022-02-03T11:42:00.000Z" title="发表于 2022-02-03 19:42:00">2022-02-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/08/28/Vagrant-default-use-root-login/" title="Vagrant 默认是用root账户登陆"><img src="https://tva1.sinaimg.cn/large/008i3skNly1gtwnzelc7mj60z609o74w02.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Vagrant 默认是用root账户登陆"></a><div class="content"><a class="title" href="/2021/08/28/Vagrant-default-use-root-login/" title="Vagrant 默认是用root账户登陆">Vagrant 默认是用root账户登陆</a><time datetime="2021-08-28T10:08:09.000Z" title="发表于 2021-08-28 18:08:09">2021-08-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/08/01/%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86maven/" title="重新认识maven"><img src="https://tva1.sinaimg.cn/large/008i3skNly1gt1o34mj37j61gm0kqwg702.jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="重新认识maven"></a><div class="content"><a class="title" href="/2021/08/01/%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86maven/" title="重新认识maven">重新认识maven</a><time datetime="2021-08-01T14:33:22.000Z" title="发表于 2021-08-01 22:33:22">2021-08-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2020/07/26/ARTS-Week-5/" title="ARTS-Week-5"><img src="https://s2.loli.net/2022/02/09/c7YfpL5ru8nDTtl.png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="ARTS-Week-5"></a><div class="content"><a class="title" href="/2020/07/26/ARTS-Week-5/" title="ARTS-Week-5">ARTS-Week-5</a><time datetime="2020-07-26T09:52:45.000Z" title="发表于 2020-07-26 17:52:45">2020-07-26</time></div></div></div></div><div class="card-widget ads-wrap"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4246138471118676" data-ad-slot="4174678027" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2022 By Jerry Wu</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">本地搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine(){function n(){new Valine(Object.assign({el:"#vcomment",appId:"AVw7kqBWv8BqLExXq2drwbG3-gzGzoHsz",appKey:"I6ePpCb4W1A02o7TIXkrgrPX",avatar:"monsterid",serverURLs:"",emojiMaps:"",path:window.location.pathname,visitor:!1},null))}"function"==typeof Valine?n():getScript("https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js").then(n)}{function loadOtherComment(){loadValine()}setTimeout(loadValine,0)}</script></div><script id="canvas_nest" defer color="0,0,255" opacity="0.7" zindex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors=["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!0,scrollRestoration:!1});document.addEventListener("pjax:send",(function(){if(window.tocScrollFn&&window.removeEventListener("scroll",window.tocScrollFn),window.scrollCollect&&window.removeEventListener("scroll",scrollCollect),"object"==typeof preloader&&preloader.initLoading(),document.getElementById("rightside").style.cssText="opacity: ''; transform: ''",window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")})),document.addEventListener("pjax:complete",(function(){window.refreshFn(),document.querySelectorAll("script[data-pjax]").forEach(e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","UA-219214701-1",{page_path:window.location.pathname}),"object"==typeof _hmt&&_hmt.push(["_trackPageview",window.location.pathname]),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll(),"object"==typeof preloader&&preloader.endLoading()})),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script async>window.onload=function(){var a=document.createElement('script'),b=document.getElementsByTagName('script')[0];a.type='text/javascript',a.async=!0,a.src='/sw-register.js?v='+Date.now(),b.parentNode.insertBefore(a,b)};</script></body></html>